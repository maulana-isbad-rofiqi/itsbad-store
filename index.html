<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kasir Online - Itsbad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="flex justify-center min-h-screen text-slate-800">

  <div class="w-full max-w-md bg-white shadow-2xl min-h-screen relative flex flex-col">
    
    <div class="bg-indigo-600 text-white p-6 pt-8 rounded-b-[2rem] shadow-lg z-10 relative">
      <div class="flex justify-between items-center mb-2">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Kasir Online</h1>
          <p class="text-indigo-200 text-xs opacity-80">Powered by Firebase</p>
        </div>
        <div id="statusIndicator" class="bg-white/10 px-3 py-1 rounded-full text-[10px] backdrop-blur-md flex items-center gap-2 border border-white/20">
          <div class="loader"></div> <span class="font-semibold">Connecting...</span>
        </div>
      </div>
    </div>

    <div class="flex-1 p-6 overflow-y-auto pb-24 relative">

      <div id="page-home" class="text-center mt-8 fade-in">
        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm mb-6">
          <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4">
             <i class="fas fa-store text-2xl text-indigo-500"></i>
          </div>
          <h2 class="font-bold text-lg text-slate-800">Masuk ke Toko</h2>
          <p class="text-sm text-slate-500 mb-6">Masukkan ID Toko unik kamu.</p>
          
          <div class="relative">
            <input type="text" id="storeIdInput" placeholder="Contoh: tokomu" class="w-full p-4 text-center bg-slate-50 border border-slate-200 rounded-xl font-bold uppercase text-slate-700 tracking-wider focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
          </div>
          
          <button onclick="checkStore()" class="w-full mt-4 bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">MASUK SEKARANG</button>
        </div>
        <p class="text-[10px] text-slate-400">Pastikan ID sama jika dibuka di HP lain.</p>
      </div>

      <div id="page-setup" class="hidden fade-in">
        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
          <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-cog text-slate-400"></i> Setup Toko</h3>
          <button onclick="logout()" class="text-xs text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded-lg transition">Keluar</button>
        </div>

        <div class="space-y-4">
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-700 mb-4">
            <i class="fas fa-info-circle mr-1"></i> Data ini akan disimpan permanen di Cloud.
          </div>

          <div>
            <label class="text-xs font-bold text-slate-500 ml-1">ID Toko</label>
            <input type="text" id="setupId" disabled class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl text-sm font-bold text-slate-500 uppercase">
          </div>
          
          <div>
            <label class="text-xs font-bold text-slate-500 ml-1">Nama Toko</label>
            <input type="text" id="setupName" placeholder="Contoh: Warung Berkah" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-indigo-500 outline-none">
          </div>

          <div>
             <label class="text-xs font-bold text-slate-500 ml-1">Nomor WhatsApp</label>
             <input type="tel" id="setupWa" placeholder="08xxxxxxxxxx" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-indigo-500 outline-none">
          </div>

          <div>
             <label class="text-xs font-bold text-slate-500 ml-1">Nominal Default (Opsional)</label>
             <input type="number" id="setupAmount" placeholder="Kosongkan jika bebas input" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-indigo-500 outline-none">
          </div>

          <div class="p-4 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 text-center hover:bg-slate-100 transition cursor-pointer relative">
            <input type="file" id="qrisFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
            <i class="fas fa-qrcode text-2xl text-slate-400 mb-2"></i>
            <p class="text-xs font-bold text-slate-500">Upload Gambar QRIS</p>
            <p class="text-[10px] text-slate-400">Klik untuk pilih file</p>
          </div>
          
          <button onclick="saveToCloud()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg mt-4 hover:bg-slate-900 transition">SIMPAN KE CLOUD ‚òÅÔ∏è</button>
        </div>
      </div>

      <div id="page-cashier" class="hidden fade-in">
        <div class="text-center mb-6">
          <h2 id="dispName" class="font-bold text-xl text-slate-800">...</h2>
          <div class="inline-block bg-slate-100 px-3 py-1 rounded-full mt-1">
             <p class="text-[10px] text-slate-500 font-mono">ID: <span id="dispId">...</span></p>
          </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-xl shadow-slate-200 border border-slate-100 flex flex-col items-center relative overflow-hidden transform transition hover:scale-[1.02] duration-300">
          <div class="absolute top-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
          
          <div class="mt-4 mb-4">
             <div id="qrContainer" class="p-1 bg-white"></div>
          </div>
          
          <h2 id="dispAmount" class="text-2xl font-bold text-slate-800 mb-1">Rp 0</h2>
          <p class="text-[10px] text-slate-400">Scan menggunakan E-Wallet / M-Banking</p>
        </div>

        <div class="mt-6">
          <h3 class="font-bold text-sm text-slate-700 mb-3 ml-1">Konfirmasi Pembayaran</h3>
          <div class="space-y-3">
             <input type="text" id="custName" class="w-full p-3.5 bg-white border border-slate-200 rounded-xl text-sm focus:border-green-500 focus:ring-1 focus:ring-green-200 outline-none shadow-sm transition" placeholder="Nama Kamu">
             <input type="text" id="custNote" class="w-full p-3.5 bg-white border border-slate-200 rounded-xl text-sm focus:border-green-500 focus:ring-1 focus:ring-green-200 outline-none shadow-sm transition" placeholder="Catatan (Opsional)">
          </div>
          
          <button onclick="sendWA()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 active:scale-95 transition">
            <i class="fab fa-whatsapp text-xl"></i> Kirim Bukti Bayar
          </button>

          <div class="mt-8 text-center border-t border-slate-200 pt-4">
             <p class="text-[10px] text-slate-400 mb-2">Ingin ubah data toko?</p>
             <button onclick="switchToAdmin()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 px-4 py-2 rounded-lg transition">Masuk sebagai Admin</button>
          </div>
        </div>
        
        <div class="mt-6 text-center pb-4">
             <p class="text-[10px] text-slate-400 mb-1">Link bayar untuk pelanggan:</p>
             <div id="shareLink" class="bg-slate-100 p-2 rounded-lg text-[10px] text-slate-500 break-all font-mono select-all cursor-pointer">...</div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    // --- IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import jsQR from "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.mjs";
    
    // --- CONFIG ASLI (DATA KAMU SUDAH SAYA MASUKKAN DISINI) ---
    // Tidak perlu file external, langsung jalan.
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
      measurementId: "G-QR6HPRX459"
    };

    // Initialize App
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const statusInd = document.getElementById('statusIndicator');
    const pageHome = document.getElementById('page-home');
    const pageSetup = document.getElementById('page-setup');
    const pageCashier = document.getElementById('page-cashier');

    // Global State
    let currentStoreId = "";
    let currentData = {};

    // Expose functions to window
    window.checkStore = checkStore;
    window.saveToCloud = saveToCloud;
    window.sendWA = sendWA;
    window.logout = logout;
    window.switchToAdmin = renderSetup;

    // Load QRCodeJS
    const qrScript = document.createElement('script');
    qrScript.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js";
    document.body.appendChild(qrScript);

    // Initial Status
    statusInd.innerHTML = '<div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> <span class="font-bold text-white">Online</span>';

    // Auto-login via URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlStore = urlParams.get('store');
    if(urlStore) {
        document.getElementById('storeIdInput').value = urlStore;
        setTimeout(checkStore, 500);
    }

    // --- FUNCTION: CEK TOKO ---
    function checkStore() {
        let id = document.getElementById('storeIdInput').value.trim();
        if(!id) return alert("Isi ID Toko dulu!");
        
        id = id.toLowerCase().replace(/[^a-z0-9-]/g, '-');
        currentStoreId = id;

        statusInd.innerHTML = '<div class="loader"></div> Loading...';

        const dbRef = ref(db);
        get(child(dbRef, `stores/${id}`)).then((snapshot) => {
            if (snapshot.exists()) {
                currentData = snapshot.val();
                renderCashier();
            } else {
                if(confirm(`Toko dengan ID "${id}" belum ada.\n\nApakah kamu Admin dan ingin membuatnya sekarang?`)) {
                    renderSetup();
                } else {
                    statusInd.innerHTML = '<span class="font-bold text-white">Online</span>';
                }
            }
        }).catch((error) => {
            console.error(error);
            alert("Gagal koneksi. Cek internet atau Rules Firebase!");
            statusInd.innerHTML = '<span class="text-red-300">Error</span>';
        });
    }

    // --- FUNCTION: RENDER SETUP ---
    function renderSetup() {
        pageHome.classList.add('hidden');
        pageCashier.classList.add('hidden');
        pageSetup.classList.remove('hidden');
        document.getElementById('setupId').value = currentStoreId;
        
        if(currentData.name) {
            document.getElementById('setupName').value = currentData.name;
            document.getElementById('setupWa').value = currentData.wa.replace('62','0');
            document.getElementById('setupAmount').value = currentData.amount || "";
        }
        
        statusInd.innerHTML = '<span class="font-bold text-yellow-300">Mode Admin</span>';
    }

    // --- FUNCTION: SAVE TO CLOUD ---
    async function saveToCloud() {
        const name = document.getElementById('setupName').value;
        let wa = document.getElementById('setupWa').value;
        const amount = document.getElementById('setupAmount').value;
        const fileInput = document.getElementById('qrisFile');

        if(!name || !wa) return alert("Nama Toko & WA Wajib diisi!");

        statusInd.innerHTML = '<div class="loader"></div> Saving...';

        let qrisString = currentData.qris || "";

        if(fileInput.files[0]) {
            try {
                qrisString = await processQRImage(fileInput.files[0]);
            } catch (e) {
                statusInd.innerHTML = 'Error';
                return alert("QRIS tidak terbaca! Pastikan gambar jelas.");
            }
        }

        if(!qrisString) {
             statusInd.innerHTML = 'Admin';
             return alert("Kamu harus upload foto QRIS minimal sekali!");
        }

        wa = wa.replace(/\D/g, '');
        if(wa.startsWith('0')) wa = '62' + wa.substring(1);

        const newData = {
            name: name,
            wa: wa,
            amount: amount ? parseInt(amount) : 0,
            qris: qrisString,
            updatedAt: Date.now()
        };

        set(ref(db, 'stores/' + currentStoreId), newData)
            .then(() => {
                alert("‚úÖ Data Toko Berhasil Disimpan!");
                currentData = newData;
                renderCashier();
            })
            .catch((error) => {
                alert("Gagal Simpan: " + error.message);
            });
    }

    // --- FUNCTION: RENDER CASHIER ---
    function renderCashier() {
        pageHome.classList.add('hidden');
        pageSetup.classList.add('hidden');
        pageCashier.classList.remove('hidden');
        statusInd.innerHTML = '<span class="font-bold text-white">üõí Kasir</span>';

        document.getElementById('dispName').innerText = currentData.name;
        document.getElementById('dispId').innerText = currentStoreId;
        document.getElementById('dispAmount').innerText = currentData.amount > 0 
            ? "Rp " + parseInt(currentData.amount).toLocaleString('id-ID')
            : "Nominal Bebas";

        generateQRDisplay(currentData.qris, currentData.amount);

        const baseUrl = window.location.href.split('?')[0];
        const fullLink = `${baseUrl}?store=${currentStoreId}`;
        document.getElementById('shareLink').innerText = fullLink;
        
        window.history.pushState({}, '', `?store=${currentStoreId}`);
    }

    // --- HELPERS ---

    function processQRImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, canvas.width, canvas.height);
                    if(code) resolve(code.data);
                    else reject("Not Found");
                };
            };
            reader.readAsDataURL(file);
        });
    }

    function generateQRDisplay(rawString, amount) {
        const container = document.getElementById('qrContainer');
        container.innerHTML = "";
        
        let finalString = rawString;
        if(amount > 0) {
            try { finalString = injectNominal(rawString, amount); } 
            catch(e) { console.error(e); }
        }

        if(typeof QRCode === 'undefined') {
            setTimeout(() => generateQRDisplay(rawString, amount), 100);
            return;
        }

        new QRCode(container, {
            text: finalString,
            width: 200,
            height: 200,
            colorDark : "#1e1e2e",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }

    function injectNominal(payload, amount) {
        function crc16(d){let c=0xFFFF;for(let i=0;i<d.length;i++){c^=d.charCodeAt(i)<<8;for(let j=0;j<8;j++){c=(c&0x8000)?(c<<1)^0x1021:c<<1;c=c&0xFFFF}}return c.toString(16).toUpperCase().padStart(4,"0")}
        function parse(p){let i=[],x=0;while(x<p.length){let id=p.substr(x,2),l=parseInt(p.substr(x+2,2));if(isNaN(l))break;i.push({id,val:p.substr(x+4,l)});x+=4+l}return i}
        
        let t = parse(payload).filter(x=>x.id!=='63');
        let i01 = t.findIndex(x=>x.id==='01'); if(i01>=0)t[i01].val='12';
        
        let am = parseFloat(amount).toFixed(2);
        let t54 = {id:'54',val:am};
        let i54 = t.findIndex(x=>x.id==='54'); let i53 = t.findIndex(x=>x.id==='53');
        
        if(i54>=0)t[i54]=t54; else if(i53>=0)t.splice(i53+1,0,t54); else t.push(t54);
        
        let body = t.map(i=>i.id+i.val.length.toString().padStart(2,'0')+i.val).join('');
        return body+"6304"+crc16(body+"6304");
    }

    function sendWA() {
        const name = document.getElementById('custName').value;
        const note = document.getElementById('custNote').value;
        if(!name) return alert("Isi nama dulu!");
        
        const total = currentData.amount > 0 ? "Rp "+parseInt(currentData.amount).toLocaleString('id-ID') : "Sesuai Aplikasi";
        const text = `*PEMBAYARAN QRIS*\n------------------\nüõí Toko: ${currentData.name}\nüë§ Nama: *${name}*\nüí∞ Nominal: *${total}*\nüìù Note: ${note}\n------------------\nBukti TF terlampir üì∏`;
        window.open(`https://wa.me/${currentData.wa}?text=${encodeURIComponent(text)}`, '_blank');
    }

    function logout() {
        if(confirm("Yakin mau keluar?")) {
            window.location.href = window.location.href.split('?')[0];
        }
    }
  </script>
</body>
</html>
