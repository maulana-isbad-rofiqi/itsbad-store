<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Itsbad Store | Layanan Digital Premium</title>
  
  <link rel="icon" href="icon.png" type="image/png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary: #4f46e5;
      --secondary: #6366f1;
      --bg-app: #f8fafc;
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background-color: var(--bg-app); 
      -webkit-tap-highlight-color: transparent;
      color: #1e293b;
    }

    .app-container { 
      max-width: 480px; 
      margin: 0 auto; 
      background: #ffffff; 
      min-height: 100vh; 
      position: relative; 
      box-shadow: 0 0 50px rgba(0,0,0,0.02); 
      padding-bottom: 110px;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }

    .bottom-nav { 
      position: fixed; 
      bottom: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      width: calc(100% - 40px); 
      max-width: 440px; 
      background: rgba(15, 23, 42, 0.95); 
      backdrop-filter: blur(12px); 
      border-radius: 24px;
      display: flex; 
      justify-content: space-around; 
      padding: 14px 0; 
      z-index: 100;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    .nav-item { color: #64748b; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; transition: 0.3s; }
    .nav-item.active { color: #ffffff; }
    .nav-item.active i { color: var(--secondary); transform: scale(1.1); }

    #live-notif {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      pointer-events: none;
      width: calc(100% - 40px);
      max-width: 380px;
    }

    .notif-anim {
      animation: slideDownIn 0.5s ease forwards, fadeOutUp 0.5s ease forwards 4.5s;
    }

    @keyframes slideDownIn {
      from { transform: translateY(-100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeOutUp {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-20px); opacity: 0; }
    }

    .premium-gradient {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }

    .receipt-paper { background: #fff; position: relative; }
    .receipt-paper::after { 
        content: ""; position: absolute; bottom: -8px; left: 0; right: 0; height: 8px; 
        background: radial-gradient(circle, transparent 70%, #fff 75%) 0 0; background-size: 12px 12px; 
    }

    .modal-up { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .modal-hidden { transform: translateY(100%); }
    
    .btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
  </style>
</head>
<body>

  <!-- Live Pop-up Container -->
  <div id="live-notif"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center p-8">
    <div class="text-center mb-12">
      <div class="w-24 h-24 mx-auto mb-6 premium-gradient rounded-[2.5rem] flex items-center justify-center shadow-2xl shadow-indigo-200 rotate-6">
        <i class="fas fa-bolt text-white text-4xl"></i>
      </div>
      <h1 class="text-3xl font-[900] text-slate-900 tracking-tight italic">ITSBAD<span class="text-indigo-600">STORE</span></h1>
      <p class="text-slate-400 mt-2 text-sm font-medium uppercase tracking-widest">Premium Digital Provider</p>
    </div>
    
    <div class="w-full max-w-xs space-y-4">
      <button onclick="loginWithGoogle()" class="w-full bg-white border border-slate-100 py-4 rounded-2xl font-bold flex items-center justify-center gap-3 shadow-sm active:scale-95 transition-all">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-5">
        <span class="text-slate-700">Masuk dengan Google</span>
      </button>
      <button onclick="continueAsGuest()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
        Mulai sebagai Tamu
      </button>
    </div>
  </div>

  <div class="app-container hidden" id="app">
    <!-- Header -->
    <header class="sticky top-0 z-[90] bg-white/80 backdrop-blur-xl px-6 py-5 flex items-center justify-between border-b border-slate-50">
        <div class="flex items-center gap-3">
             <div class="relative">
                <img id="headerAvatar" src="https://ui-avatars.com/api/?name=G" class="w-11 h-11 rounded-2xl border-2 border-white shadow-md object-cover">
                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
             </div>
             <div>
                <p class="text-[10px] font-bold text-slate-400 uppercase">Halo, Selamat Datang!</p>
                <h1 class="text-sm font-extrabold text-slate-900 leading-none mt-1" id="headerGreeting">Guest User</h1>
             </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSearch()" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-500"><i class="fas fa-search"></i></button>
            <button onclick="openAdminLogin()" id="nav-admin-btn" class="hidden w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="searchBar" class="hidden px-6 py-4 bg-white border-b border-slate-50">
        <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="searchInput" onkeyup="filterProducts()" placeholder="Cari layanan premium..." class="w-full bg-slate-50 pl-11 pr-4 py-3 rounded-2xl text-sm focus:outline-none">
        </div>
    </div>

    <!-- Main Content -->
    <main id="homePage" class="p-6">
        <div class="relative w-full h-48 rounded-[2.5rem] premium-gradient p-8 flex flex-col justify-center shadow-2xl shadow-indigo-100 mb-8 overflow-hidden group">
             <div class="absolute -right-5 -top-5 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
             <div class="relative z-10">
                <span class="bg-white/20 text-white text-[9px] font-bold px-3 py-1 rounded-full backdrop-blur-md border border-white/20 uppercase">Official Hub</span>
                <h2 class="text-2xl font-extrabold text-white mt-4 leading-tight">Layanan Digital <br>Terbaik & Terpercaya</h2>
                <div class="flex items-center gap-2 mt-5">
                    <button onclick="switchTab('apps')" class="bg-white text-indigo-600 px-5 py-2 rounded-xl text-[10px] font-bold shadow-lg">Lihat App Gratis</button>
                    <a href="https://cek-nomer-xl.vercel.app/" target="_blank" class="w-9 h-9 bg-white/10 text-white rounded-xl flex items-center justify-center border border-white/20"><i class="fas fa-sim-card"></i></a>
                </div>
             </div>
        </div>

        <div class="mb-8">
            <h3 class="font-extrabold text-slate-900 tracking-tight mb-4">Pilih Kategori</h3>
            <div id="categoryContainer" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"></div>
        </div>

        <h3 class="font-extrabold text-slate-900 tracking-tight mb-4">Katalog Produk</h3>
        <div id="productGrid" class="grid grid-cols-2 gap-4 pb-12"></div>
    </main>

    <!-- App Page -->
    <main id="downloadPage" class="hidden p-6">
        <div class="mb-8">
            <h2 class="text-2xl font-extrabold text-slate-900">App Store</h2>
            <p class="text-sm text-slate-400 mt-1">Download tool & aplikasi pilihan kami.</p>
        </div>
        <div id="appList" class="space-y-4 pb-20"></div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button onclick="switchTab('home')" class="nav-item active" id="nav-home"><i class="fas fa-house text-xl"></i><span>Home</span></button>
        <button onclick="openCart()" class="nav-item relative" id="nav-cart">
            <i class="fas fa-shopping-bag text-xl"></i>
            <span id="cartBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-indigo-500 text-white text-[10px] flex items-center justify-center rounded-full border-2 border-slate-900 hidden">0</span>
            <span>Keranjang</span>
        </button>
        <button onclick="switchTab('apps')" class="nav-item" id="nav-apps"><i class="fas fa-th-large text-xl"></i><span>Apps</span></button>
        <button onclick="openProfile()" class="nav-item" id="nav-profile"><i class="fas fa-user-circle text-xl"></i><span>Akun</span></button>
    </nav>

    <!-- Modals -->
    <div id="detailModal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeDetail()"></div>
        <div id="detailContent" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[3rem] p-0 max-w-[480px] mx-auto h-[90vh] flex flex-col overflow-hidden modal-up modal-hidden">
            <div class="relative h-[45%] bg-slate-100">
                <button onclick="closeDetail()" class="absolute top-6 left-6 w-11 h-11 bg-white/90 backdrop-blur rounded-2xl flex items-center justify-center z-10 shadow-lg"><i class="fas fa-chevron-left"></i></button>
                <img id="detailImg" class="w-full h-full object-cover">
            </div>
            <div class="p-8 flex-1 flex flex-col overflow-y-auto no-scrollbar">
                <div id="detailCat" class="text-[10px] font-extrabold text-indigo-500 uppercase tracking-widest mb-2">CATEGORY</div>
                <h2 id="detailName" class="text-2xl font-extrabold text-slate-900 mb-6">Product Name</h2>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Harga</p>
                        <p id="detailPrice" class="text-lg font-extrabold text-indigo-600">Rp 0</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Stok</p>
                        <p id="detailStock" class="text-sm font-extrabold text-slate-700">0</p>
                    </div>
                </div>
                <p id="detailDesc" class="text-sm text-slate-500 leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <div class="p-6 bg-white border-t">
                <button onclick="addToCartFromDetail()" class="w-full premium-gradient text-white py-5 rounded-2xl font-extrabold shadow-xl">TAMBAH KE KERANJANG</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 z-[150] hidden">
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm" onclick="closeCart()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[3rem] p-8 max-w-[480px] mx-auto h-[85vh] flex flex-col">
            <div class="w-16 h-1.5 bg-slate-100 rounded-full mx-auto mb-8"></div>
            <h2 class="font-extrabold text-2xl mb-6 tracking-tight">Keranjang Anda</h2>
            <div id="cartList" class="flex-1 overflow-y-auto no-scrollbar space-y-4"></div>
            <div class="pt-6 mt-4 border-t border-slate-50">
                <div class="p-4 bg-indigo-50 rounded-2xl mb-6 flex items-center gap-4 border border-indigo-100">
                    <input type="text" id="orderNote" class="flex-1 bg-transparent text-sm font-medium focus:outline-none placeholder:text-indigo-300" placeholder="Tujuan / No. HP / ID Akun">
                </div>
                <div class="flex justify-between items-center mb-6">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Tagihan</p>
                    <p class="text-2xl font-extrabold text-indigo-600" id="cartTotalDisplay">Rp 0</p>
                </div>
                <button onclick="initPayment()" id="btnCheckout" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold shadow-xl active:scale-95 transition-all">LANJUT PEMBAYARAN</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 z-[300] hidden bg-white flex flex-col p-8">
        <header class="flex items-center justify-between mb-10">
            <button onclick="closePayment()" class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-extrabold text-xl">Pembayaran</h2>
            <div class="w-12"></div>
        </header>
        <div class="flex-1 flex flex-col items-center">
            <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total Transfer</p>
            <h3 id="payAmountDisplay" class="text-4xl font-[900] text-slate-900 mb-10">Rp 0</h3>
            <div class="bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-100">
                <div id="qrContainer" class="p-2 bg-white rounded-xl min-h-[220px] flex items-center justify-center"></div>
                <div class="text-center mt-4 bg-green-500 text-white py-1.5 rounded-full text-[10px] font-bold">NOMINAL OTOMATIS</div>
            </div>
            <p class="text-[11px] text-slate-400 text-center mt-12 px-6">Scan QRIS di atas menggunakan aplikasi pembayaran favorit Anda dan selesaikan transaksi.</p>
        </div>
        <button onclick="generateReceipt()" class="w-full premium-gradient text-white py-5 rounded-2xl font-extrabold shadow-xl">SAYA SUDAH BAYAR</button>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 z-[400] hidden bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div id="receiptCard" class="receipt-paper p-8 rounded-t-[2.5rem]">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-check"></i></div>
                    <h2 class="font-extrabold text-xl">Transaksi Berhasil</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-1" id="receiptDate">-</p>
                </div>
                <div id="receiptItems" class="space-y-2 mb-4 border-y border-dashed border-slate-200 py-4"></div>
                <div class="flex justify-between items-center font-extrabold">
                    <span class="text-xs">Total</span>
                    <span id="receiptTotal" class="text-indigo-600">Rp 0</span>
                </div>
                <div id="receiptNoteBox" class="mt-4 p-3 bg-slate-50 rounded-xl text-[10px] text-slate-500 italic"></div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="location.reload()" class="flex-1 bg-white/10 text-white py-4 rounded-2xl font-bold border border-white/20">Tutup</button>
                <button onclick="sendToWhatsapp()" class="flex-[2] bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg">HUBUNGI ADMIN</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-[150] hidden bg-white flex flex-col">
        <header class="p-6 border-b flex items-center justify-between">
            <h2 class="font-extrabold text-xl">Akun Saya</h2>
            <button onclick="closeProfile()" class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center"><i class="fas fa-times"></i></button>
        </header>
        <div class="p-6 space-y-6 overflow-y-auto">
            <div class="flex flex-col items-center mb-6">
                <div class="w-24 h-24 rounded-[2rem] border-4 border-white shadow-xl overflow-hidden mb-4">
                    <img id="profileAvatarEdit" src="https://ui-avatars.com/api/?name=Guest" class="w-full h-full object-cover">
                </div>
                <input type="file" id="uploadAvatar" accept="image/*" class="text-xs text-slate-400" onchange="handleAvatarUpload(this)">
            </div>
            <div class="space-y-4">
                <input type="text" id="profName" class="w-full bg-slate-50 border-none px-5 py-4 rounded-2xl text-sm font-bold" placeholder="Nama Lengkap">
                <input type="tel" id="profPhone" class="w-full bg-slate-50 border-none px-5 py-4 rounded-2xl text-sm font-bold" placeholder="No. WhatsApp">
            </div>
            <button onclick="saveProfileData()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold shadow-xl">SIMPAN PROFIL</button>
            <button onclick="doLogout()" class="w-full text-red-500 bg-red-50 py-5 rounded-2xl font-bold mt-2">KELUAR</button>
            <div class="pt-6 border-t border-dashed">
                <h4 class="font-extrabold text-sm mb-4">Riwayat Pesanan</h4>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" class="fixed inset-0 z-[500] hidden bg-slate-50 overflow-y-auto">
        <header class="sticky top-0 bg-white px-6 py-5 shadow-sm flex justify-between items-center z-[501]">
            <h2 class="font-extrabold text-slate-900">Admin Panel</h2>
            <button onclick="closeAdminPanel()" class="text-red-500 font-bold text-xs uppercase bg-red-50 px-3 py-1.5 rounded-lg">Tutup</button>
        </header>
        <div class="p-6">
            <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm">
                <button onclick="switchAdminTab('products')" id="tabAdmProd" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl text-xs font-bold">PRODUK</button>
                <button onclick="switchAdminTab('apps')" id="tabAdmApp" class="flex-1 py-3 bg-transparent text-slate-400 rounded-xl text-xs font-bold">APP</button>
                <button onclick="switchAdminTab('settings')" id="tabAdmSet" class="flex-1 py-3 bg-transparent text-slate-400 rounded-xl text-xs font-bold">CONFIG</button>
            </div>
            <div id="adminBody"></div>
        </div>
    </div>

    <!-- Admin Pin Modal -->
    <div id="adminLoginModal" class="fixed inset-0 z-[400] hidden bg-slate-900/60 backdrop-blur flex items-center justify-center p-8">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Akses Admin</h2>
            <form id="pinForm" class="space-y-6">
                <input type="password" id="adminPin" maxlength="6" class="w-full text-center text-4xl tracking-[0.5em] font-mono border-b-2 border-slate-200 outline-none focus:border-indigo-500 py-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                <div class="flex gap-3">
                    <button type="button" onclick="closeAdminLogin()" class="flex-1 py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold">BATAL</button>
                    <button type="submit" class="flex-1 py-4 premium-gradient text-white rounded-2xl font-bold shadow-lg">MASUK</button>
                </div>
            </form>
        </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99"
    };
    const STORE_ID="itsbad-store", OWNER_WA="6285236363128", ADMIN_PIN="110603", ADMIN_EMAIL="isbadd84@gmail.com";
    
    // Variabel global
    let db, auth, user, storeData={name:"Itsbad Store",fee:0,products:[],downloads:[]}, 
        cart=JSON.parse(localStorage.getItem('cart'))||[], userProfile={}, isGuestMode=false, activeCategory='all';
    
    // Deklarasi fungsi global di window object
    window.cart = cart;
    window.storeData = storeData;
    window.userProfile = userProfile;
    window.isGuestMode = isGuestMode;
    
    // --- QRIS GEN ---
    function generateCRC16(data) {
        let crc = 0xFFFF;
        for (let i = 0; i < data.length; i++) {
            crc ^= data.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021; else crc = crc << 1;
                crc = crc & 0xFFFF;
            }
        }
        return crc.toString(16).toUpperCase().padStart(4, "0");
    }
    function parseTLV(payload) {
        const items = []; let pos = 0;
        while (pos < payload.length) {
            const id = payload.substr(pos, 2);
            const lenStr = payload.substr(pos + 2, 2);
            const len = parseInt(lenStr, 10);
            if (isNaN(len)) break;
            const val = payload.substr(pos + 4, len);
            items.push({ id, val }); pos += 4 + len;
        }
        return items;
    }
    function buildTLV(items) { return items.map(item => item.id + item.val.length.toString().padStart(2,'0') + item.val).join(''); }
    function formatQrisAmount(qrisRaw, amount) {
        if(!qrisRaw) return "";
        let tlv = parseTLV(qrisRaw.trim()).filter(x => x.id !== '63');
        const idx01 = tlv.findIndex(x => x.id === '01'); if (idx01 >= 0) tlv[idx01].val = '12';
        tlv = tlv.filter(x => x.id !== '55');
        const tag54 = { id: '54', val: amount.toString() };
        const idx54 = tlv.findIndex(x => x.id === '54');
        const idx53 = tlv.findIndex(x => x.id === '53');
        if (idx54 >= 0) tlv[idx54] = tag54; else if (idx53 >= 0) tlv.splice(idx53 + 1, 0, tag54); else tlv.push(tag54);
        let body = buildTLV(tlv);
        return body + "6304" + generateCRC16(body + "6304");
    }

    // --- LIVE NOTIF ---
    const localNames = ["Andi", "Siti", "Budi", "Dewi", "Reza", "Putri", "Kevin", "Rizky", "Indah", "Dian", "Ahmad", "Maya", "Lestari", "Siska"];
    function showLiveNotif() {
        if(!storeData.products || storeData.products.length === 0) return;
        const name = localNames[Math.floor(Math.random() * localNames.length)];
        const prod = storeData.products[Math.floor(Math.random() * storeData.products.length)].name;
        const html = `
            <div class="notif-anim bg-white/95 backdrop-blur-xl p-4 rounded-3xl shadow-2xl flex items-center gap-4 border border-indigo-100">
                <div class="w-10 h-10 rounded-2xl premium-gradient flex items-center justify-center text-white shrink-0"><i class="fas fa-shopping-bag"></i></div>
                <div class="overflow-hidden">
                    <p class="text-[11px] font-bold text-slate-800 leading-tight">${name} <span class="font-normal text-slate-500">baru saja memesan</span></p>
                    <p class="text-[10px] text-indigo-600 font-extrabold truncate uppercase mt-0.5">${prod}</p>
                </div>
            </div>
        `;
        $("#live-notif").html(html);
        setTimeout(() => $("#live-notif").html(""), 5500);
    }

    // --- UI FUNCTIONS ---
    window.toggleSearch = () => $("#searchBar").slideToggle();
    window.filterCat = (c) => { activeCategory = c; renderCategories(); renderProducts(); };
    window.filterProducts = () => renderProducts($("#searchInput").val());
    window.switchTab = (t) => {
        $(".nav-item").removeClass('active'); $(`#nav-${t}`).addClass('active');
        if(t === 'home') { $("#homePage").show(); $("#downloadPage").hide(); }
        else if(t === 'apps') { $("#homePage").hide(); $("#downloadPage").show(); renderApps(); }
    };
    
    window.openDetail = (i) => {
        const p = storeData.products[i]; window.currentDetailIdx = i;
        $("#detailImg").attr('src', p.image || 'https://placehold.co/400'); 
        $("#detailName").text(p.name);
        $("#detailPrice").text("Rp " + (parseInt(p.price)||0).toLocaleString('id-ID'));
        $("#detailDesc").text(p.desc || "-");
        $("#detailStock").text(p.stock || 0);
        $("#detailCat").text((p.category || "Umum").toUpperCase());
        $("#detailModal").removeClass('hidden'); 
        setTimeout(() => $("#detailContent").removeClass('modal-hidden'), 10);
    };
    
    window.closeDetail = () => { 
        $("#detailContent").addClass('modal-hidden'); 
        setTimeout(() => $("#detailModal").addClass('hidden'), 400); 
    };
    
    window.addToCartFromDetail = () => {
        const i = window.currentDetailIdx; 
        const p = storeData.products[i];
        if(parseInt(p.stock) <= 0) return toastr.error("Stok kosong");
        const ex = cart.find(c => c.idx === i); 
        if(ex) ex.qty++; 
        else cart.push({idx: i, name: p.name, price: parseInt(p.price), qty: 1});
        localStorage.setItem('cart', JSON.stringify(cart)); 
        updateCartBadge(); 
        toastr.success("Berhasil ditambahkan ke keranjang!"); 
        closeDetail();
    };
    
    window.updateCartBadge = () => { 
        const t = cart.reduce((a, b) => a + b.qty, 0); 
        if(t > 0) $("#cartBadge").text(t).removeClass('hidden'); 
        else $("#cartBadge").addClass('hidden'); 
    };

    window.openCart = () => { 
        renderCartList(); 
        $("#cartModal").removeClass('hidden'); 
    };
    
    window.closeCart = () => $("#cartModal").addClass('hidden');
    
    window.renderCartList = () => {
        if(cart.length === 0) {
            $("#cartList").html('<div class="py-20 text-center text-slate-300">Keranjang kosong</div>');
            $("#cartTotalDisplay").text("Rp 0"); 
            $("#btnCheckout").addClass('btn-disabled'); 
            return;
        }
        $("#btnCheckout").removeClass('btn-disabled');
        let total = 0;
        $("#cartList").html(cart.map((item, i) => {
            total += (item.price * item.qty);
            return `<div class="flex items-center gap-4 bg-slate-50 p-4 rounded-3xl border border-slate-100">
                <div class="flex-1 overflow-hidden">
                    <h4 class="text-xs font-bold text-slate-800 truncate">${item.name}</h4>
                    <p class="text-[10px] text-indigo-600 font-bold mt-1">Rp ${item.price.toLocaleString('id-ID')}</p>
                </div>
                <div class="flex items-center gap-3 bg-white px-3 py-1.5 rounded-2xl shadow-sm">
                    <button onclick="changeQty(${i}, -1)"><i class="fas fa-minus text-[10px]"></i></button>
                    <span class="text-xs font-bold">${item.qty}</span>
                    <button onclick="changeQty(${i}, 1)"><i class="fas fa-plus text-[10px]"></i></button>
                </div>
            </div>`;
        }).join(''));
        
        const fee = parseInt(storeData.fee) || 0;
        $("#cartTotalDisplay").text("Rp " + (total + fee).toLocaleString('id-ID'));
    };
    
    window.changeQty = (i, d) => { 
        cart[i].qty += d; 
        if(cart[i].qty <= 0) cart.splice(i, 1); 
        localStorage.setItem('cart', JSON.stringify(cart)); 
        updateCartBadge(); 
        renderCartList(); 
    };

    // --- CHECKOUT FIXED ---
    window.initPayment = () => {
        if(cart.length === 0) return toastr.error("Keranjang kosong!");
        
        const note = $("#orderNote").val().trim() || "-";
        const sub = cart.reduce((a, b) => a + (b.price * b.qty), 0);
        const fee = parseInt(storeData.fee) || 0;
        const total = sub + fee;
        
        $("#payAmountDisplay").text("Rp " + total.toLocaleString('id-ID'));
        $("#qrContainer").empty();
        
        if(storeData.qris) {
            try {
                const qrisFinal = formatQrisAmount(storeData.qris, total);
                new QRCode(document.getElementById("qrContainer"), { 
                    text: qrisFinal, 
                    width: 220, 
                    height: 220 
                });
                $("#cartModal").addClass('hidden'); 
                $("#paymentModal").removeClass('hidden');
            } catch(error) {
                console.error("QRIS Error:", error);
                toastr.error("Gagal membuat QRIS. Cek format QRIS admin.");
            }
        } else {
            toastr.error("QRIS Admin belum diatur!");
        }
    };

    window.closePayment = () => $("#paymentModal").addClass('hidden');

    window.generateReceipt = async () => {
        const sub = cart.reduce((a,b)=>a+(b.price*b.qty),0); 
        const fee = parseInt(storeData.fee)||0; 
        const total = sub+fee;
        const now = new Date();
        
        $("#receiptDate").text(now.toLocaleString('id-ID'));
        $("#receiptTotal").text("Rp " + total.toLocaleString('id-ID'));
        $("#receiptItems").html(cart.map(i => 
            `<div class="flex justify-between text-xs font-bold">
                <span>${i.name} x${i.qty}</span>
                <span>Rp ${(i.price*i.qty).toLocaleString()}</span>
            </div>`
        ).join(''));
        
        $("#receiptNoteBox").text("ðŸ“ " + ($("#orderNote").val() || "-"));
        
        if(user && !isGuestMode) {
            try {
                await push(ref(db, `orders/${user.uid}`), { 
                    items: [...cart], 
                    subtotal: sub, 
                    fee, 
                    total, 
                    note: $("#orderNote").val()||"-", 
                    date: Date.now(), 
                    status: "pending" 
                });
            } catch(e) {
                console.error("Save order error:", e);
            }
        }
        
        $("#paymentModal").addClass('hidden'); 
        $("#receiptModal").removeClass('hidden');
    };

    window.sendToWhatsapp = () => {
        const note = $("#orderNote").val() || "-";
        const total = $("#receiptTotal").text();
        let m = `*INVOICE ITSBAD STORE*\n-----------------\nðŸ‘¤: ${userProfile.name||'Tamu'}\nðŸ“…: ${$("#receiptDate").text()}\n-----------------\n`;
        cart.forEach(i => m += `â€¢ ${i.name} (x${i.qty}) - Rp ${(i.price*i.qty).toLocaleString()}\n`);
        m += `-----------------\n*TOTAL: ${total}*\nCatatan: ${note}\n-----------------\n_Kirim bukti bayar segera._`;
        window.open(`https://wa.me/${OWNER_WA}?text=${encodeURIComponent(m)}`, '_blank');
        setTimeout(() => { 
            cart=[]; 
            localStorage.setItem('cart','[]'); 
            updateCartBadge();
            $("#receiptModal").addClass('hidden');
            location.reload(); 
        }, 1500);
    };

    // --- APPS PAGE ---
    function renderApps() {
        if(!storeData.downloads || storeData.downloads.length === 0) { 
            $("#appList").html('<div class="py-20 text-center text-slate-300">Belum ada aplikasi</div>'); 
            return; 
        }
        $("#appList").html(storeData.downloads.map(a => `
            <div class="flex items-center gap-4 bg-white p-4 rounded-[1.8rem] border border-slate-50 shadow-sm">
                <img src="${a.icon || 'https://placehold.co/100'}" class="w-14 h-14 rounded-2xl object-cover border border-slate-100">
                <div class="flex-1 overflow-hidden">
                    <h3 class="font-extrabold text-sm text-slate-800 truncate">${a.name}</h3>
                    <p class="text-[10px] text-slate-400 line-clamp-1">${a.category || 'App'}</p>
                </div>
                <a href="${a.link}" target="_blank" class="w-10 h-10 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-download text-xs"></i>
                </a>
            </div>
        `).join(''));
    }

    // --- MAIN APP FUNCTIONS ---
    window.loginWithGoogle = async () => {
        try { 
            const provider = new GoogleAuthProvider();
            const result = await signInWithPopup(auth, provider); 
            user = result.user; 
            isGuestMode = false; 
            initStore(); 
        } catch(e) { 
            console.error("Login error:", e);
            toastr.error("Login Gagal"); 
        }
    };
    
    window.continueAsGuest = () => { 
        isGuestMode = true; 
        user = { uid: 'guest_' + Date.now(), displayName: 'Tamu' }; 
        userProfile = { name: 'Tamu' }; 
        initStore(); 
    };

    window.initStore = async () => {
        try {
            const snapshot = await get(child(ref(db), `stores/${STORE_ID}`));
            if(snapshot.exists()) {
                storeData = snapshot.val();
            }
            if(!storeData.products) storeData.products = [];
            if(!storeData.downloads) storeData.downloads = [];

            $("#loginModal").addClass('hidden');
            $("#app").removeClass('hidden');
            
            if(user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                $("#nav-admin-btn").removeClass('hidden');
            }
            
            renderCategories();
            renderProducts();
            updateCartBadge();
            
            if(user && !isGuestMode) {
                await loadProfile(user.uid);
            } else {
                $("#headerGreeting").text(userProfile.name || 'Tamu');
            }
            
            // Setup live notifications
            setInterval(showLiveNotif, 12000); 
            showLiveNotif();
            
            toastr.success("Selamat datang di Itsbad Store!");
        } catch(error) {
            console.error("Init store error:", error);
            toastr.error("Gagal memuat toko");
        }
    };

    window.renderCategories = () => {
        const cats = ['all'];
        storeData.products.forEach(p => { 
            if(p.category && !cats.includes(p.category)) cats.push(p.category); 
        });
        
        $("#categoryContainer").html(cats.map(k => `
            <button onclick="filterCat('${k}')" class="shrink-0 px-6 py-3 rounded-2xl text-[11px] font-extrabold transition-all ${activeCategory===k ? 'bg-indigo-600 text-white shadow-xl shadow-indigo-100' : 'bg-white text-slate-400 border border-slate-100'}">
                ${k === 'all' ? 'SEMUA' : k.toUpperCase()}
            </button>
        `).join(''));
    };

    window.renderProducts = (searchQuery = "") => {
        let filtered = storeData.products || [];
        if(activeCategory !== 'all') {
            filtered = filtered.filter(p => p.category === activeCategory);
        }
        if(searchQuery) {
            filtered = filtered.filter(p => 
                p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (p.category && p.category.toLowerCase().includes(searchQuery.toLowerCase()))
            );
        }
        
        if(filtered.length === 0) { 
            $("#productGrid").html('<div class="col-span-2 py-20 text-center text-slate-300">Produk tidak ditemukan</div>'); 
            return; 
        }

        $("#productGrid").html(filtered.map((p, i) => {
            const realIdx = storeData.products.indexOf(p);
            const isHabis = parseInt(p.stock) <= 0;
            return `
            <div class="bg-white p-4 rounded-[2rem] flex flex-col border border-slate-50 shadow-sm active:scale-95 transition-all" onclick="openDetail(${realIdx})">
                <div class="relative aspect-square rounded-[1.5rem] overflow-hidden mb-4 bg-slate-50">
                    <img src="${p.image || 'https://placehold.co/400'}" class="w-full h-full object-cover">
                    ${isHabis ? '<div class="absolute inset-0 bg-slate-900/60 flex items-center justify-center text-white text-[9px] font-extrabold uppercase">HABIS</div>' : ''}
                </div>
                <div class="flex-1">
                    <p class="text-[9px] font-extrabold text-indigo-500 uppercase tracking-widest mb-1.5">${p.category || 'UMUM'}</p>
                    <h3 class="text-xs font-extrabold text-slate-800 line-clamp-2 leading-snug mb-3 h-8">${p.name}</h3>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-[900] text-slate-900">Rp ${(parseInt(p.price)||0).toLocaleString('id-ID')}</span>
                    <div class="w-8 h-8 rounded-xl ${isHabis?'bg-slate-200 text-slate-400':'bg-slate-900 text-white shadow-lg'} flex items-center justify-center text-[10px]">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
            </div>`;
        }).join(''));
    };

    // --- ADMIN PANEL ---
    window.openAdminLogin = () => $("#adminLoginModal").removeClass('hidden');
    window.closeAdminLogin = () => $("#adminLoginModal").addClass('hidden');
    
    $("#pinForm").on('submit', (e) => {
        e.preventDefault(); 
        if($("#adminPin").val() === ADMIN_PIN) { 
            $("#adminLoginModal").addClass('hidden'); 
            $("#adminModal").removeClass('hidden'); 
            switchAdminTab('products'); 
        } else {
            toastr.error("PIN Salah");
        }
    });
    
    window.closeAdminPanel = () => $("#adminModal").addClass('hidden');

    window.switchAdminTab = (tab) => {
        $("#tabAdmProd, #tabAdmApp, #tabAdmSet").removeClass('bg-indigo-600 text-white shadow-lg').addClass('text-slate-400');
        if(tab==='products') { 
            $("#tabAdmProd").addClass('bg-indigo-600 text-white shadow-lg'); 
            renderAdminProducts(); 
        }
        else if(tab==='apps') { 
            $("#tabAdmApp").addClass('bg-indigo-600 text-white shadow-lg'); 
            renderAdminApps(); 
        }
        else { 
            $("#tabAdmSet").addClass('bg-indigo-600 text-white shadow-lg'); 
            renderAdminSettings(); 
        }
    };

    // URUTAN GESER PRODUK
    window.moveProd = async (i, dir) => {
        const arr = storeData.products;
        const target = i + dir;
        if (target < 0 || target >= arr.length) return;
        [arr[i], arr[target]] = [arr[target], arr[i]];
        renderAdminProducts(); 
        renderProducts();
        await update(ref(db, `stores/${STORE_ID}`), storeData);
        toastr.success("Urutan Diperbarui");
    };

    function renderAdminProducts() {
        let html = `<div class="bg-white p-6 rounded-[2rem] shadow-sm mb-6 space-y-4">
            <h4 class="text-xs font-bold uppercase text-slate-400">Tambah Produk</h4>
            <div onclick="document.getElementById('admImgInp').click()" class="w-full h-32 bg-slate-50 border-2 border-dashed rounded-2xl flex items-center justify-center text-slate-300 relative overflow-hidden">
                <img id="admImgPrev" class="w-full h-full object-cover hidden">
                <i id="admImgIcon" class="fas fa-camera text-2xl"></i>
            </div>
            <input type="file" id="admImgInp" class="hidden" onchange="handleAdmImg(this)">
            <input id="admPName" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Nama Produk">
            <input id="admPPrice" type="number" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Harga">
            <input id="admPStock" type="number" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Stok">
            <input id="admPCat" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Kategori">
            <textarea id="admPDesc" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none h-20" placeholder="Deskripsi"></textarea>
            <button onclick="saveAdmProd()" class="w-full premium-gradient text-white py-4 rounded-2xl font-bold">SIMPAN PRODUK</button>
        </div><div class="space-y-3">`;
        
        storeData.products.forEach((p, i) => {
            html += `<div class="bg-white p-4 rounded-3xl border border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="${p.image||'https://placehold.co/50'}" class="w-10 h-10 rounded-xl object-cover">
                    <div>
                        <p class="text-xs font-bold">${p.name}</p>
                        <p class="text-[9px] text-slate-400">Rp ${parseInt(p.price).toLocaleString()}</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="moveProd(${i}, -1)" class="w-7 h-7 bg-slate-50 rounded-lg text-slate-400"><i class="fas fa-chevron-up"></i></button>
                    <button onclick="moveProd(${i}, 1)" class="w-7 h-7 bg-slate-50 rounded-lg text-slate-400"><i class="fas fa-chevron-down"></i></button>
                    <button onclick="delAdmProd(${i})" class="w-7 h-7 bg-red-50 rounded-lg text-red-400 ml-1"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        });
        html += `</div>`; 
        $("#adminBody").html(html);
    }

    window.saveAdmProd = async () => {
        const p = { 
            name: $("#admPName").val(), 
            category: $("#admPCat").val(), 
            price: $("#admPPrice").val(), 
            stock: $("#admPStock").val(), 
            desc: $("#admPDesc").val(), 
            image: window.tempAdmImg || "" 
        };
        if(!p.name || !p.price) return toastr.error("Nama dan harga harus diisi!");
        storeData.products.push(p);
        await update(ref(db, `stores/${STORE_ID}`), storeData); 
        toastr.success("Produk disimpan!"); 
        renderAdminProducts(); 
        renderProducts(); 
        window.tempAdmImg = "";
        
        // Reset form
        $("#admPName, #admPCat, #admPPrice, #admPStock, #admPDesc").val("");
        $("#admImgPrev").addClass('hidden'); 
        $("#admImgIcon").show();
    };
    
    window.delAdmProd = async (i) => { 
        if(confirm("Hapus produk ini?")) { 
            storeData.products.splice(i, 1); 
            await update(ref(db, `stores/${STORE_ID}`), storeData); 
            renderAdminProducts(); 
            renderProducts(); 
            toastr.success("Produk dihapus!");
        } 
    };
    
    window.handleAdmImg = (input) => {
        const f = input.files[0]; 
        if(f) {
            const r = new FileReader(); 
            r.onload = (e) => {
                const img = new Image(); 
                img.onload = () => {
                    const c = document.createElement('canvas'); 
                    let w=img.width, h=img.height; 
                    if(w>400){h=(h*400)/w;w=400;}
                    c.width=w; c.height=h; 
                    c.getContext('2d').drawImage(img,0,0,w,h);
                    window.tempAdmImg = c.toDataURL('image/jpeg', 0.8); 
                    $("#admImgPrev").attr('src', window.tempAdmImg).removeClass('hidden'); 
                    $("#admImgIcon").hide();
                }; 
                img.src = e.target.result;
            }; 
            r.readAsDataURL(f);
        }
    };
    
    window.renderAdminApps = () => {
        let html = `<div class="bg-white p-6 rounded-[2rem] shadow-sm mb-6 space-y-4">
            <h4 class="text-xs font-bold uppercase text-slate-400">Tambah App Gratis</h4>
            <input id="admAppName" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Nama App">
            <input id="admAppCat" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Kategori">
            <input id="admAppLink" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" placeholder="Link Download">
            <button onclick="saveAdmApp()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">SIMPAN APP</button>
        </div><div class="space-y-3">`;
        
        (storeData.downloads||[]).forEach((a, i) => {
            html += `<div class="bg-white p-4 rounded-3xl flex justify-between items-center">
                <p class="text-xs font-bold">${a.name}</p>
                <button onclick="delAdmApp(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>
            </div>`;
        });
        $("#adminBody").html(html + '</div>');
    };
    
    window.saveAdmApp = async () => {
        const a = { 
            name: $("#admAppName").val(), 
            category: $("#admAppCat").val(), 
            link: $("#admAppLink").val() 
        };
        if(!a.name || !a.link) return toastr.error("Nama dan link harus diisi!");
        if(!storeData.downloads) storeData.downloads = []; 
        storeData.downloads.push(a);
        await update(ref(db, `stores/${STORE_ID}`), storeData); 
        renderAdminApps();
        toastr.success("App disimpan!");
        
        // Reset form
        $("#admAppName, #admAppCat, #admAppLink").val("");
    };
    
    window.renderAdminSettings = () => {
        $("#adminBody").html(`<div class="bg-white p-6 rounded-[2rem] shadow-sm space-y-6">
            <h4 class="text-xs font-bold uppercase text-slate-400">Config</h4>
            <input id="admStoreName" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" value="${storeData.name}">
            <input id="admFee" type="number" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-xs font-bold outline-none" value="${storeData.fee}">
            <textarea id="admQris" class="w-full bg-slate-50 px-5 py-3 rounded-2xl text-[9px] font-mono h-20">${storeData.qris||''}</textarea>
            <p class="text-[10px] text-slate-400 italic">*Paste kode QRIS Anda di atas</p>
            <button onclick="saveAdmSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">SIMPAN</button>
        </div>`);
    };
    
    window.saveAdmSettings = async () => {
        storeData.name = $("#admStoreName").val(); 
        storeData.fee = $("#admFee").val(); 
        storeData.qris = $("#admQris").val();
        await update(ref(db, `stores/${STORE_ID}`), storeData); 
        toastr.success("Pengaturan disimpan!");
    };

    // --- PROFILE ---
    window.openProfile = () => $("#profileModal").removeClass('hidden');
    window.closeProfile = () => $("#profileModal").addClass('hidden');
    window.doLogout = () => {
        signOut(auth).then(() => {
            location.reload();
        }).catch(e => {
            console.error("Logout error:", e);
            location.reload();
        });
    };
    
    window.loadProfile = async (uid) => {
        try {
            const snapshot = await get(child(ref(db), `users/${uid}`));
            if(snapshot.exists()) {
                userProfile = snapshot.val();
            } else {
                userProfile = { name: user.displayName || 'Pengguna' };
            }
            $("#headerGreeting").text(userProfile.name); 
            $("#profName").val(userProfile.name); 
            $("#profPhone").val(userProfile.phone || '');
            if(userProfile.avatar) { 
                $("#headerAvatar, #profileAvatarEdit").attr('src', userProfile.avatar); 
            }
        } catch(error) {
            console.error("Load profile error:", error);
        }
    };
    
    window.saveProfileData = async () => {
        userProfile.name = $("#profName").val(); 
        userProfile.phone = $("#profPhone").val();
        try {
            await update(ref(db, `users/${user.uid}`), userProfile); 
            $("#headerGreeting").text(userProfile.name);
            toastr.success("Profil disimpan!");
        } catch(error) {
            console.error("Save profile error:", error);
            toastr.error("Gagal menyimpan profil");
        }
    };

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    auth = getAuth(app);
    
    // Set up auth state listener
    onAuthStateChanged(auth, (currentUser) => { 
        if(currentUser) { 
            user = currentUser; 
            initStore(); 
        } else {
            // Show login modal if not logged in
            $("#loginModal").removeClass('hidden');
        }
    });

    // Initialize the app when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        // Check if user is already logged in
        if(auth.currentUser) {
            user = auth.currentUser;
            initStore();
        }
    });

  </script>
</body>
</html>
