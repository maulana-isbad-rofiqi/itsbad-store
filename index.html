
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Itsbad Store - Premium Digital Shop</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
    
    body { 
        font-family: 'Outfit', sans-serif; 
        background-color: #f8fafc; 
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
    }
    
    .loader { border: 3px solid #e2e8f0; border-radius: 50%; border-top: 3px solid #4f46e5; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    #qrContainer img { margin: 0 auto; border: 8px solid white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    
    .glass-nav { 
        background: rgba(255, 255, 255, 0.85); 
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    }

    .slide-up-enter { transform: translateY(100%); opacity: 0; }
    .slide-up-active { transform: translateY(0); opacity: 1; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    
    .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); }
    
    .product-card { transition: all 0.3s ease; }
    .product-card:active { transform: scale(0.98); }
    
    #toast-container > div { opacity: 1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 12px; }
  </style>
</head>
<body class="flex justify-center min-h-screen text-slate-800">

  <div class="w-full max-w-md bg-white/80 shadow-[0_20px_50px_rgba(8,_112,_184,_0.1)] min-h-screen relative flex flex-col overflow-hidden backdrop-blur-sm border-x border-white/50">
    
    <div class="glass-nav px-5 py-4 z-50 sticky top-0 flex justify-between items-center h-20">
        <div class="flex items-center gap-3">
            <div onclick="window.showProfile()" class="cursor-pointer group">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-slate-100 ring-2 ring-white shadow-sm flex items-center justify-center overflow-hidden transition group-hover:scale-105">
                    <i class="fas fa-user text-slate-400"></i>
                </div>
            </div>
            <div class="flex flex-col">
                <h1 class="text-base font-bold leading-tight tracking-tight text-slate-800" id="shopNameDisplay">Itsbad Store</h1>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-[11px] font-medium text-slate-500 truncate max-w-[120px]" id="userNameDisplay">Menunggu Login...</p>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="window.toggleCart()" class="relative p-3 bg-white rounded-xl shadow-sm text-slate-600 hover:text-indigo-600 hover:shadow-md transition border border-slate-100 group">
                <i class="fas fa-shopping-bag text-lg transition group-hover:scale-110"></i>
                <span id="cartCount" class="absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-white hidden shadow-sm">0</span>
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 relative no-scrollbar pb-24" id="mainContainer">

      <div class="mb-6 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 p-6 text-white shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10 blur-xl"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-yellow-400 opacity-20 rounded-full -ml-10 -mb-10 blur-xl"></div>
        <h2 class="font-bold text-xl mb-1 relative z-10">Premium Digital</h2>
        <p class="text-indigo-100 text-xs relative z-10">Paket Internet, VPN & Akun Premium Termurah & Terpercaya.</p>
      </div>

      <div id="authOverlay" class="fixed inset-0 bg-white/95 backdrop-blur-md z-[60] flex flex-col items-center justify-center p-8 hidden transition-opacity duration-300">
          <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-3xl flex items-center justify-center mb-8 shadow-xl shadow-indigo-200 rotate-3 hover:rotate-6 transition">
              <i class="fas fa-bolt text-4xl text-white"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2 text-slate-800">Selamat Datang</h2>
          <p class="text-slate-500 text-sm mb-10 text-center leading-relaxed">Nikmati kemudahan belanja produk digital dengan pembayaran Qris.</p>
          
          <button onclick="window.loginGoogle()" class="w-full bg-white border border-slate-200 py-4 rounded-2xl font-bold text-slate-700 flex items-center justify-center gap-3 shadow-sm hover:bg-slate-50 hover:shadow-md transition mb-3 group">
              <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5 group-hover:scale-110 transition"> Masuk dengan Google
          </button>
          
          <button onclick="window.loginGuest()" class="w-full bg-slate-100 py-4 rounded-2xl font-bold text-slate-600 hover:bg-slate-200 transition">
              Lanjut sebagai Tamu
          </button>
      </div>

      <div id="page-shop">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-slate-800">Produk Terbaru</h3>
            <span class="text-xs text-indigo-600 font-semibold bg-indigo-50 px-2 py-1 rounded-lg">All Items</span>
        </div>

        <div id="productGrid" class="grid grid-cols-2 gap-4 pb-24">
            <div class="col-span-2 text-center py-20 text-slate-400">
                <div class="loader mx-auto mb-3"></div> Memuat Produk...
            </div>
        </div>
      </div>
    </div>

    <div id="cartModal" class="fixed inset-0 z-50 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity duration-300 backdrop-blur-sm" id="cartBackdrop" onclick="window.toggleCart()"></div>
        <div class="absolute bottom-0 left-0 w-full bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) pointer-events-auto max-h-[85vh] flex flex-col" id="cartSheet">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-xl text-slate-800">Keranjang</h3>
                </div>
                <button onclick="window.toggleCart()" class="w-9 h-9 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="cartItems" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar min-h-[200px] bg-slate-50/50"></div>
            <div class="p-6 bg-white border-t border-slate-100">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-500">Subtotal</span>
                    <span class="font-bold text-slate-800" id="cartSubtotal">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm mb-4">
                    <span class="text-slate-500">Fee</span>
                    <span class="font-bold text-indigo-600" id="cartFee">+ Rp 0</span>
                </div>
                <div class="flex justify-between items-end mb-6">
                    <span class="text-slate-800 font-bold">Total Pembayaran</span>
                    <span class="text-2xl font-bold text-indigo-600 leading-none" id="cartTotal">Rp 0</span>
                </div>
                <button onclick="window.processCheckout()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 hover:scale-[1.02] transition active:scale-95">
                    BAYAR SEKARANG <i class="fas fa-arrow-right ml-2 text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-white z-[60] hidden flex-col">
        <div class="p-5 border-b flex items-center gap-4 bg-white sticky top-0 z-10">
            <button onclick="window.closePayment()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-bold text-lg">Pembayaran</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6 text-center bg-slate-50/50">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-violet-500"></div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">Total Tagihan Anda</p>
                <h1 class="text-4xl font-extrabold text-slate-800" id="payTotal">Rp 0</h1>
            </div>
            <div class="bg-white border border-slate-200 p-6 rounded-3xl mb-6 shadow-sm">
                <p class="text-xs font-bold text-slate-400 mb-4 tracking-wide">SCAN QRIS PEMBAYARAN</p>
                <div id="qrContainer" class="flex justify-center min-h-[220px] items-center py-2">
                    <p class="text-xs text-slate-300 animate-pulse">Memuat QRIS...</p>
                </div>
                <div class="mt-4 bg-orange-50 border border-orange-100 text-orange-600 px-3 py-2 rounded-lg text-[10px] inline-block font-medium" id="qrNote">
                   <i class="fas fa-bolt mr-1"></i> Nominal otomatis
                </div>
            </div>
            <div class="text-left mb-6">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">Nama Pembeli</label>
                <input type="text" id="custName" class="w-full p-4 border border-slate-200 rounded-2xl bg-white text-slate-600 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-100" readonly>
            </div>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex gap-3 items-start text-left shadow-sm">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600 mt-1">
                    <i class="fas fa-info text-sm"></i>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-blue-900 mb-1">Konfirmasi Pembayaran</h4>
                    <p class="text-xs text-blue-700 leading-relaxed">
                        Silakan lakukan pembayaran sesuai nominal. Setelah itu klik tombol di bawah untuk <b>mengirim bukti transfer</b> ke WhatsApp Admin.
                    </p>
                </div>
            </div>
        </div>
        <div class="p-5 border-t bg-white pb-8">
            <button onclick="window.sendOrder()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-2xl"></i> KONFIRMASI VIA WHATSAPP
            </button>
        </div>
    </div>

    <div id="productDetailModal" class="fixed inset-0 modal-overlay z-[80] hidden items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white rounded-t-[2rem] sm:rounded-3xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto no-scrollbar transform transition-transform duration-300" id="detailCard">
            <div class="relative">
                <div class="absolute top-4 right-4 z-10">
                    <button onclick="window.closeProductDetail()" class="w-9 h-9 bg-white/80 backdrop-blur rounded-full flex items-center justify-center text-slate-800 shadow-sm hover:bg-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="detailImageContainer" class="w-full h-64 bg-slate-100 flex items-center justify-center overflow-hidden">
                   </div>
            </div>
            <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-0">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <div class="flex items-start justify-between mb-2">
                    <h1 id="detailName" class="text-2xl font-bold text-slate-800 leading-tight">Nama Produk</h1>
                </div>
                <div class="flex items-center gap-3 mb-6">
                    <p id="detailPrice" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">Rp 0</p>
                    <div class="h-6 w-[1px] bg-slate-200"></div>
                    <p id="detailStock" class="text-sm font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-md">Stok: 0</p>
                </div>
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-slate-900 mb-2">Deskripsi</h3>
                    <p id="detailDescription" class="text-slate-500 text-sm leading-relaxed">Deskripsi produk akan muncul di sini.</p>
                </div>
                <div class="flex gap-3 sticky bottom-0 bg-white pt-2 pb-4 border-t border-slate-50">
                    <button id="detailAddToCart" onclick="window.addToCartFromDetail()" class="flex-1 bg-white border-2 border-slate-900 text-slate-900 py-4 rounded-2xl font-bold hover:bg-slate-50 transition">
                        TAMBAH
                    </button>
                    <button onclick="window.buyNowFromDetail()" class="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 transition">
                        BELI SEKARANG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-white/95 backdrop-blur-sm z-[70] hidden flex-col overflow-y-auto">
        <div class="sticky top-0 bg-white/80 backdrop-blur-md p-5 border-b border-slate-100 flex justify-between items-center z-10">
            <h2 class="font-bold text-lg">Edit Profil</h2>
            <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="w-9 h-9 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 max-w-md mx-auto w-full">
            <div class="flex flex-col items-center mb-8">
                <div class="relative group">
                    <div id="profileAvatar" class="w-28 h-28 rounded-full bg-slate-100 flex items-center justify-center overflow-hidden border-4 border-white shadow-xl">
                        <i class="fas fa-user text-slate-300 text-4xl"></i>
                    </div>
                    <label for="avatarUpload" class="absolute bottom-0 right-0 w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white cursor-pointer shadow-lg hover:bg-indigo-600 transition hover:scale-110">
                        <i class="fas fa-camera text-sm"></i>
                    </label>
                    <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                </div>
                <h3 class="font-bold text-xl mt-4 text-slate-800" id="profileName">Loading...</h3>
                <p class="text-sm text-slate-400" id="profileEmail">Loading...</p>
            </div>
            <div class="space-y-5">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Nama Lengkap</label>
                        <input type="text" id="editName" class="w-full p-4 border border-slate-200 rounded-2xl bg-white mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" placeholder="Nama Anda">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Nomor WhatsApp</label>
                        <div class="flex gap-2 mt-1">
                            <div class="flex items-center px-4 bg-slate-50 border border-slate-200 rounded-2xl">
                                <span class="text-slate-600 font-bold font-mono text-sm">ðŸ‡®ðŸ‡© +62</span>
                            </div>
                            <input type="tel" id="editPhone" class="flex-1 p-4 border border-slate-200 rounded-2xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" placeholder="8123xxxxx">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Alamat (Opsional)</label>
                        <textarea id="editAddress" class="w-full p-4 border border-slate-200 rounded-2xl bg-white mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" rows="2" placeholder="Kota/Email untuk pengiriman"></textarea>
                    </div>
                </div>
                <div class="bg-amber-50 p-5 rounded-2xl border border-amber-100">
                    <h4 class="font-bold text-sm text-amber-800 mb-3 flex items-center"><i class="fas fa-history mr-2"></i>Riwayat Transaksi Terakhir</h4>
                    <div id="orderHistory" class="text-sm space-y-2">
                        <p class="text-center py-2 text-amber-600/70 italic text-xs">Belum ada riwayat</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-3 pb-10">
                <button onclick="window.saveProfile()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-800 transition">SIMPAN PERUBAHAN</button>
                <button onclick="window.logout()" class="w-full bg-white border border-slate-200 text-red-500 py-4 rounded-2xl font-bold hover:bg-red-50 transition">KELUAR AKUN</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="fixed inset-0 bg-slate-100 z-[90] hidden overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 shadow-sm flex justify-between items-center z-10 border-b">
            <h2 class="font-bold text-lg">Admin Dashboard</h2>
            <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-xs font-bold bg-red-100 text-red-600 px-3 py-2 rounded-lg">Tutup</button>
        </div>
        
        <div id="adminLoginForm" class="p-10 text-center mt-20">
            <div class="w-20 h-20 bg-slate-800 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl rotate-3">
                <i class="fas fa-shield-alt text-white text-3xl"></i>
            </div>
            <h3 class="font-bold text-xl mb-6 text-slate-800">Verifikasi Admin</h3>
            <input type="password" id="adminPin" class="w-full p-4 rounded-2xl border-none ring-1 ring-slate-200 text-center text-2xl mb-6 bg-white shadow-sm focus:ring-2 focus:ring-slate-800 outline-none" placeholder="******" maxlength="6">
            <button onclick="window.loginAdmin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-800 transition">MASUK DASHBOARD</button>
        </div>

        <div id="adminContent" class="p-5 space-y-6 hidden max-w-lg mx-auto">
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider">Konfigurasi Toko</h3>
                <input type="text" id="setStoreName" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" value="Itsbad Store" placeholder="Nama Toko">
                <input type="number" id="setFee" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" placeholder="Biaya Admin (Rp)">
                
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-3">
                    <p class="text-[10px] font-bold text-blue-600 mb-1">Upload QRIS Merchant</p>
                    <p class="text-[10px] text-blue-500 leading-tight">Gunakan QRIS dari Dana Bisnis/Shopee agar nominal otomatis.</p>
                </div>
                <input type="file" id="qrisUpload" class="text-xs w-full mb-2">
                <textarea id="setQris" class="w-full p-3 text-[10px] bg-slate-900 text-green-400 rounded-xl font-mono mb-4" rows="2" readonly placeholder="String QRIS..."></textarea>
                <button onclick="window.saveSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200">SIMPAN PENGATURAN</button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider" id="formTitle">Tambah Produk Baru</h3>
                
                <input type="hidden" id="editProdIndex" value="-1">

                <div class="mb-4 text-center">
                    <div id="previewContainer" class="w-24 h-24 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 mx-auto flex items-center justify-center overflow-hidden relative group cursor-pointer" onclick="document.getElementById('prodImageUpload').click()">
                        <img id="imgPreview" class="hidden w-full h-full object-cover">
                        <div id="imgPlaceholder" class="text-slate-400 flex flex-col items-center">
                            <i class="fas fa-camera mb-1"></i>
                            <span class="text-[10px]">Foto</span>
                        </div>
                    </div>
                    <input type="file" id="prodImageUpload" accept="image/*" class="hidden" onchange="window.handleImageUpload(this)">
                    <p class="text-[10px] text-slate-400 mt-2">Klik kotak untuk upload foto</p>
                </div>

                <input type="text" id="newProdName" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-slate-50 focus:bg-white transition" placeholder="Nama Produk">
                <div class="flex gap-3 mb-3">
                    <input type="number" id="newProdPrice" class="w-1/2 p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white" placeholder="Harga (Rp)">
                    <input type="number" id="newProdStock" class="w-1/2 p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white" placeholder="Stok">
                </div>
                <textarea id="newProdDesc" class="w-full p-3 border border-slate-200 rounded-xl mb-4 text-sm bg-slate-50 focus:bg-white" placeholder="Deskripsi Singkat" rows="3"></textarea>
                
                <div class="flex gap-2">
                    <button onclick="window.cancelEdit()" id="btnCancelEdit" class="hidden w-1/3 bg-slate-200 text-slate-600 py-3 rounded-xl text-sm font-bold">BATAL</button>
                    <button onclick="window.saveProduct()" id="btnSaveProd" class="flex-1 bg-green-500 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-200">PUBLISH PRODUK</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider">Katalog Produk</h3>
                <div id="adminProdList" class="space-y-2 max-h-80 overflow-y-auto pr-1"></div>
            </div>
            
            <div class="h-10"></div>
        </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
      measurementId: "G-QR6HPRX459"
    };

    const STORE_ID = "itsbad-store";
    const OWNER_WA = "6285236363128";

    // Init Variables
    let db, auth, user;
    let storeData = { name: "Itsbad Store", fee: 0, products: [] };
    let cart = JSON.parse(localStorage.getItem('myCart')) || [];
    let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
    let currentProductDetail = null;
    let tempImageBase64 = ""; // Variable to hold uploaded image string
    
    toastr.options = { 
        "positionClass": "toast-top-center", 
        "timeOut": "2000",
        "showMethod": "slideDown",
        "hideMethod": "slideUp",
        "closeButton": false,
        "progressBar": true
    };

    const urlParams = new URLSearchParams(window.location.search);
    const isAdminPage = urlParams.get('page') === 'admin';

    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('authOverlay').classList.add('opacity-0');
                setTimeout(() => document.getElementById('authOverlay').classList.add('hidden'), 300);
                loadUserProfile(u.uid);
                initStore();
                if(isAdminPage) setTimeout(() => document.getElementById('adminPanel').classList.remove('hidden'), 500);
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('authOverlay').classList.remove('opacity-0');
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });
    } catch(e) { console.error(e); alert("Firebase Config Error: " + e.message); }

    // --- USER & AUTH FUNCTIONS ---
    async function loadUserProfile(uid) {
        try {
            const snap = await get(child(ref(db), `users/${uid}`));
            if(snap.exists()) {
                userProfile = snap.val();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                loadOrderHistory(uid);
            } else {
                userProfile = { name: user.displayName || "Pelanggan Baru", email: user.email || "", phone: "", address: "", avatar: user.photoURL || "", createdAt: Date.now() };
                await set(ref(db, `users/${uid}`), userProfile);
            }
        } catch(e) { console.log("Using local profile"); }
    }

    function updateProfileDisplay() {
        document.getElementById('userNameDisplay').innerText = userProfile.name || "Pelanggan";
        const avatarEl = document.getElementById('userAvatar');
        const imgUrl = (userProfile.avatar && userProfile.avatar !== "local") ? userProfile.avatar : user.photoURL;
        if(imgUrl) avatarEl.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
        
        document.getElementById('profileName').innerText = userProfile.name || "Pelanggan";
        document.getElementById('profileEmail').innerText = userProfile.email || "";
        document.getElementById('editName').value = userProfile.name || "";
        document.getElementById('editPhone').value = userProfile.phone || "";
        document.getElementById('editAddress').value = userProfile.address || "";
        
        const profileAvatar = document.getElementById('profileAvatar');
        if(imgUrl) profileAvatar.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
    }

    window.saveProfile = async () => {
        const newName = document.getElementById('editName').value;
        const newPhone = document.getElementById('editPhone').value;
        const newAddress = document.getElementById('editAddress').value;
        if(!newName.trim()) return toastr.warning("Nama tidak boleh kosong");
        
        userProfile.name = newName;
        userProfile.phone = newPhone;
        userProfile.address = newAddress;
        
        try {
            await update(ref(db, `users/${user.uid}`), userProfile);
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            toastr.success("Profil tersimpan!");
            setTimeout(() => document.getElementById('profileModal').classList.add('hidden'), 500);
        } catch(e) { toastr.error("Gagal menyimpan profil"); }
    };

    document.getElementById('avatarUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        if(file.size > 2 * 1024 * 1024) return toastr.warning("Ukuran maksimal 2MB");
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            userProfile.avatar = ev.target.result;
            try {
                await update(ref(db, `users/${user.uid}`), { avatar: userProfile.avatar });
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                toastr.success("Foto profil diupdate!");
            } catch(e) { toastr.error("Gagal update foto"); }
        };
        reader.readAsDataURL(file);
    });

    async function loadOrderHistory(uid) {
        try {
            const snap = await get(child(ref(db), `orders/${uid}`));
            if(snap.exists()) {
                const orders = snap.val();
                let html = '<div class="space-y-3">';
                Object.entries(orders).reverse().slice(0, 5).forEach(([key, order]) => {
                    const date = new Date(order.timestamp || key).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                    html += `<div class="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex justify-between items-center"><div class="overflow-hidden"><p class="text-[10px] text-slate-400 mb-1">${date}</p><p class="text-xs font-bold text-slate-700 truncate w-32">${order.items.split(',')[0]}</p></div><span class="font-bold text-amber-600 text-sm">Rp ${parseInt(order.total || 0).toLocaleString()}</span></div>`;
                });
                document.getElementById('orderHistory').innerHTML = html + '</div>';
            }
        } catch(e) { console.log("No history"); }
    }

    // --- STORE ---
    async function initStore() {
        try {
            const snap = await get(child(ref(db), `stores/${STORE_ID}`));
            if(snap.exists()) {
                storeData = snap.val();
                if(!storeData.products) storeData.products = [];
            } else {
                storeData = { name: "Itsbad Store", fee: 0, products: [] };
                await set(ref(db, `stores/${STORE_ID}`), storeData);
            }
            renderStore();
        } catch(e) { console.error(e); renderStore(); }
    }

    function renderStore() {
        document.getElementById('shopNameDisplay').innerText = storeData.name || "Itsbad Store";
        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";
        
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                const hasStock = parseInt(p.stock) > 0;
                // Check if product has image, else use default icon
                const imgDisplay = p.image 
                    ? `<img src="${p.image}" class="w-full h-full object-cover transition duration-300 group-hover:scale-110">`
                    : `<i class="fas fa-cube text-4xl group-hover:scale-110 transition duration-300 text-indigo-200"></i>`;
                
                const bgClass = p.image ? "bg-slate-100" : "bg-gradient-to-br from-indigo-50 to-blue-50";

                grid.innerHTML += `
                <div class="product-card bg-white p-4 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-white flex flex-col h-full relative overflow-hidden group cursor-pointer fade-in" onclick="window.showProductDetail(${i})" style="animation-delay: ${i*0.1}s">
                    ${!hasStock ? '<div class="absolute inset-0 bg-white/60 backdrop-blur-[2px] flex items-center justify-center font-bold text-red-500 z-10 text-sm border-2 border-red-100 rounded-3xl m-2">HABIS</div>' : ''}
                    <div class="w-full aspect-square ${bgClass} rounded-2xl mb-4 flex items-center justify-center overflow-hidden shadow-inner">
                        ${imgDisplay}
                    </div>
                    <h3 class="font-bold text-sm text-slate-800 leading-tight mb-1 truncate">${p.name}</h3>
                    <p class="text-xs text-slate-400 mb-3 truncate">${p.desc || 'No Description'}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <p class="font-extrabold text-indigo-600 text-sm">Rp ${parseInt(p.price).toLocaleString()}</p>
                        <button onclick="event.stopPropagation(); window.addToCart(${i})" class="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-200 transition disabled:bg-slate-200" ${!hasStock ? 'disabled':''}>
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
        } else {
            grid.innerHTML = `<div class="col-span-2 text-center text-slate-400 py-10">Belum ada produk.</div>`;
        }
        updateCartBadge();
    }

    // --- PRODUCT DETAIL ---
    window.showProductDetail = (index) => {
        currentProductDetail = index;
        const p = storeData.products[index];
        document.getElementById('detailName').innerText = p.name;
        document.getElementById('detailPrice').innerText = `Rp ${parseInt(p.price).toLocaleString()}`;
        document.getElementById('detailStock').innerText = `Stok: ${p.stock}`;
        document.getElementById('detailDescription').innerText = p.desc || 'Tidak ada deskripsi';
        
        const imgContainer = document.getElementById('detailImageContainer');
        if(p.image) {
            imgContainer.innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
        } else {
            imgContainer.innerHTML = `<i class="fas fa-cube text-8xl opacity-20 text-indigo-500"></i>`;
        }

        const addBtn = document.getElementById('detailAddToCart');
        const hasStock = parseInt(p.stock) > 0;
        addBtn.disabled = !hasStock;
        addBtn.innerHTML = hasStock ? '<i class="fas fa-cart-plus mr-2"></i> TAMBAH' : 'HABIS';
        addBtn.className = hasStock ? "flex-1 bg-white border-2 border-slate-900 text-slate-900 py-4 rounded-2xl font-bold hover:bg-slate-50 transition" : "flex-1 bg-slate-100 text-slate-400 border-2 border-slate-200 py-4 rounded-2xl font-bold cursor-not-allowed";

        const modal = document.getElementById('productDetailModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        const card = document.getElementById('detailCard');
        card.classList.add('translate-y-full');
        setTimeout(() => card.classList.remove('translate-y-full'), 50);
    };

    window.closeProductDetail = () => {
        const card = document.getElementById('detailCard');
        card.classList.add('translate-y-full');
        setTimeout(() => document.getElementById('productDetailModal').classList.add('hidden'), 300);
    };

    window.addToCartFromDetail = () => { if(currentProductDetail !== null) { window.addToCart(currentProductDetail); window.closeProductDetail(); } };
    window.buyNowFromDetail = () => { if(currentProductDetail !== null) { const p = storeData.products[currentProductDetail]; if(parseInt(p.stock)>0) { const exist=cart.find(c=>c.index===currentProductDetail); if(!exist) { cart.push({index:currentProductDetail, name:p.name, price:parseInt(p.price), qty:1, stock:parseInt(p.stock)}); saveCart(); } window.closeProductDetail(); window.toggleCart(); } else toastr.warning("Stok Habis"); } };

    // --- CART ---
    window.addToCart = (index) => {
        const p = storeData.products[index];
        const exist = cart.find(c => c.index === index);
        if(exist) { if(exist.qty < p.stock) exist.qty++; else return toastr.warning("Stok maksimal!"); } 
        else cart.push({ index, name: p.name, price: parseInt(p.price), qty: 1, stock: parseInt(p.stock) });
        saveCart();
        toastr.success("Masuk keranjang!");
    };
    window.updateQty = (idx, change) => {
        if(cart[idx].qty + change > 0 && cart[idx].qty + change <= cart[idx].stock) cart[idx].qty += change;
        else if (cart[idx].qty + change <= 0 && confirm("Hapus item?")) cart.splice(idx, 1);
        saveCart();
    };
    function saveCart() { localStorage.setItem('myCart', JSON.stringify(cart)); updateCartBadge(); renderCart(); }
    function updateCartBadge() { const c = cart.reduce((a,b)=>a+b.qty,0); const el=document.getElementById('cartCount'); el.innerText=c; c>0?el.classList.remove('hidden'):el.classList.add('hidden'); }
    function renderCart() {
        const el = document.getElementById('cartItems'); el.innerHTML = ""; let sub = 0;
        if(cart.length===0) el.innerHTML = `<div class="text-center text-slate-400 py-12">Keranjang kosong</div>`;
        else cart.forEach((c,i) => { sub+=c.price*c.qty; el.innerHTML+=`<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-200 shadow-sm"><div class="flex-1"><h4 class="font-bold text-sm text-slate-800">${c.name}</h4><p class="text-xs text-indigo-600 font-bold mt-1">Rp ${c.price.toLocaleString()}</p></div><div class="flex items-center gap-3 bg-slate-50 rounded-xl p-1 border border-slate-100"><button onclick="window.updateQty(${i},-1)" class="w-7 h-7 flex items-center justify-center font-bold">-</button><span class="text-sm font-bold w-4 text-center">${c.qty}</span><button onclick="window.updateQty(${i},1)" class="w-7 h-7 flex items-center justify-center font-bold">+</button></div></div>`; });
        const fee = parseInt(storeData.fee||0);
        document.getElementById('cartSubtotal').innerText="Rp "+sub.toLocaleString();
        document.getElementById('cartFee').innerText="+ Rp "+fee.toLocaleString();
        document.getElementById('cartTotal').innerText="Rp "+(sub+fee).toLocaleString();
    }
    window.toggleCart = () => { const m=document.getElementById('cartBackdrop'); const s=document.getElementById('cartSheet'); if(s.classList.contains('translate-y-full')) { renderCart(); m.parentElement.classList.remove('pointer-events-none'); m.classList.remove('opacity-0'); s.classList.remove('translate-y-full'); } else { m.parentElement.classList.add('pointer-events-none'); m.classList.add('opacity-0'); s.classList.add('translate-y-full'); } };

    // --- CHECKOUT ---
    window.processCheckout = () => {
        if(cart.length===0) return toastr.warning("Keranjang kosong!");
        if(user.isAnonymous && !userProfile.phone) { toastr.warning("Isi No. WA dulu!"); window.showProfile(); window.toggleCart(); return; }
        window.toggleCart();
        const tot = cart.reduce((a,b)=>a+b.qty*b.price,0) + parseInt(storeData.fee||0);
        document.getElementById('payTotal').innerText="Rp "+tot.toLocaleString();
        document.getElementById('custName').value=userProfile.name||"Pelanggan";
        document.getElementById('paymentModal').classList.remove('hidden');
        document.getElementById('paymentModal').classList.add('flex');
        generateQR(tot);
    };
    window.closePayment = () => { document.getElementById('paymentModal').classList.add('hidden'); document.getElementById('paymentModal').classList.remove('flex'); };
    function generateQR(amount) {
        const c = document.getElementById('qrContainer'); c.innerHTML = "";
        let q = storeData.qris; const n = document.getElementById('qrNote');
        if(!q) { c.innerHTML = "<div class='text-center text-xs text-red-500'>QRIS belum diset</div>"; return; }
        if(q.startsWith("http")||q.length<50) { n.innerHTML="Input Nominal Manual"; n.className="mt-4 bg-orange-50 text-orange-600 px-3 py-2 rounded-lg text-[10px]"; }
        else { try { q = injectAmount(q, amount); n.innerHTML="Nominal Otomatis"; n.className="mt-4 bg-green-50 text-green-600 px-3 py-2 rounded-lg text-[10px]"; } catch(e){} }
        new QRCode(c, { text: q, width: 180, height: 180 });
    }
    function injectAmount(p, a) {
        let raw = p.slice(0,-4).replace("010211","010212"); const s=a+".00"; const t="54"+s.length.toString().padStart(2,'0')+s;
        raw = raw.includes("5802ID") ? raw.replace(/(5802ID.*?)(?=59)/, "$1"+t) : raw+t; // Simplified injection logic
        return raw + crc16(raw);
    }
    function crc16(s) { let crc=0xFFFF; for(let i=0;i<s.length;i++) { crc^=s.charCodeAt(i)<<8; for(let j=0;j<8;j++) crc=(crc&0x8000)?(crc<<1)^0x1021:crc<<1; } return (crc&0xFFFF).toString(16).toUpperCase().padStart(4,'0'); }

    window.sendOrder = async () => {
        let list=""; cart.forEach(c=>list+=`â–ªï¸ ${c.name} (${c.qty}x)\n`);
        const sub = cart.reduce((a,b)=>a+b.qty*b.price,0); const fee=parseInt(storeData.fee||0); const tot=sub+fee;
        const msg = `*ORDER BARU - ITSBAD STORE*\nðŸ‘¤ ${userProfile.name}\nðŸ“± ${userProfile.phone?'+62'+userProfile.phone:'-'}\n\n*Pesanan:*\n${list}Total: Rp ${tot.toLocaleString()}\n\nMohon dicek pembayaran saya.`;
        try { await push(ref(db, `orders/${user.uid}`), { user:user.uid, userName:userProfile.name, items:cart.map(c=>`${c.name} (${c.qty}x)`).join(','), total:tot, timestamp:Date.now(), status:"pending" }); } catch(e){}
        window.open(`https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`, '_blank');
        cart=[]; saveCart(); setTimeout(()=>window.location.reload(),2000);
    };

    // --- ADMIN LOGIC (NEW: EDIT & IMAGE UPLOAD) ---
    window.loginAdmin = () => { if(document.getElementById('adminPin').value==="110603") { document.getElementById('adminLoginForm').classList.add('hidden'); document.getElementById('adminContent').classList.remove('hidden'); loadAdminData(); } else toastr.error("PIN Salah"); };
    
    function loadAdminData() {
        document.getElementById('setStoreName').value = storeData.name;
        document.getElementById('setFee').value = storeData.fee;
        document.getElementById('setQris').value = storeData.qris || "";
        renderAdminList();
    }

    // 1. Handle Image Upload & Compress to Base64
    window.handleImageUpload = (input) => {
        const file = input.files[0];
        if(!file) return;
        
        // Loader / UI Feedback
        document.getElementById('imgPlaceholder').innerHTML = '<div class="loader"></div>';
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // Compress Logic: Max Width 300px
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 300; 
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to Base64 string (low quality to save DB space)
                tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // Preview
                const preview = document.getElementById('imgPreview');
                preview.src = tempImageBase64;
                preview.classList.remove('hidden');
                document.getElementById('imgPlaceholder').classList.add('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    // 2. Render Admin List with Edit Button
    function renderAdminList() {
        const el = document.getElementById('adminProdList'); el.innerHTML = "";
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                el.innerHTML += `
                <div class="flex justify-between p-3 bg-slate-50 rounded-xl border border-slate-200 mb-2 items-center">
                    <div class="flex items-center gap-3 w-1/2">
                        <div class="w-8 h-8 rounded bg-slate-200 overflow-hidden flex-shrink-0">
                             ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-xs text-slate-400"><i class="fas fa-box"></i></div>'}
                        </div>
                        <div class="overflow-hidden">
                            <span class="text-xs truncate font-bold text-slate-700 block">${p.name}</span>
                            <span class="text-[10px] text-slate-400">Stok: ${p.stock}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="text-xs text-indigo-600 font-bold mr-2">Rp ${parseInt(p.price).toLocaleString()}</span>
                         <button onclick="window.editProd(${i})" class="text-blue-500 w-7 h-7 rounded-full bg-blue-50 hover:bg-blue-100 flex items-center justify-center transition"><i class="fas fa-pencil text-xs"></i></button>
                         <button onclick="window.delProd(${i})" class="text-red-500 w-7 h-7 rounded-full bg-red-50 hover:bg-red-100 flex items-center justify-center transition"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`;
            });
        } else el.innerHTML = '<p class="text-center text-xs text-slate-400 italic">Kosong</p>';
    }

    // 3. Edit Logic
    window.editProd = (i) => {
        const p = storeData.products[i];
        document.getElementById('formTitle').innerText = "Edit Produk";
        document.getElementById('editProdIndex').value = i; // Set Index
        
        document.getElementById('newProdName').value = p.name;
        document.getElementById('newProdPrice').value = p.price;
        document.getElementById('newProdStock').value = p.stock;
        document.getElementById('newProdDesc').value = p.desc;
        
        // Handle Image Preview
        if(p.image) {
            tempImageBase64 = p.image;
            document.getElementById('imgPreview').src = p.image;
            document.getElementById('imgPreview').classList.remove('hidden');
            document.getElementById('imgPlaceholder').classList.add('hidden');
        } else {
            resetImagePreview();
        }

        // Change Button State
        document.getElementById('btnSaveProd').innerText = "UPDATE PRODUK";
        document.getElementById('btnSaveProd').classList.replace('bg-green-500', 'bg-blue-600');
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        
        // Scroll to form
        document.getElementById('formTitle').scrollIntoView({behavior: 'smooth'});
    };

    window.cancelEdit = () => {
        document.getElementById('formTitle').innerText = "Tambah Produk Baru";
        document.getElementById('editProdIndex').value = "-1";
        document.getElementById('newProdName').value = "";
        document.getElementById('newProdPrice').value = "";
        document.getElementById('newProdStock').value = "";
        document.getElementById('newProdDesc').value = "";
        resetImagePreview();
        
        document.getElementById('btnSaveProd').innerText = "PUBLISH PRODUK";
        document.getElementById('btnSaveProd').classList.replace('bg-blue-600', 'bg-green-500');
        document.getElementById('btnCancelEdit').classList.add('hidden');
    };

    function resetImagePreview() {
        tempImageBase64 = "";
        document.getElementById('prodImageUpload').value = "";
        document.getElementById('imgPreview').classList.add('hidden');
        document.getElementById('imgPlaceholder').classList.remove('hidden');
        document.getElementById('imgPlaceholder').innerHTML = '<i class="fas fa-camera mb-1"></i><span class="text-[10px]">Foto</span>';
    }

    // 4. Save (Add or Update)
    window.saveProduct = async () => {
        const idx = parseInt(document.getElementById('editProdIndex').value);
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const stock = document.getElementById('newProdStock').value;
        const desc = document.getElementById('newProdDesc').value;

        if(!name || !price) return toastr.warning("Nama dan Harga wajib diisi");

        const productObj = {
            name, 
            price: parseInt(price) || 0,
            stock: parseInt(stock) || 0,
            desc: desc || "",
            image: tempImageBase64 || "" // Save image string
        };

        if(!storeData.products) storeData.products = [];

        if(idx === -1) {
            // Add New
            storeData.products.push(productObj);
            toastr.success("Produk Ditambah!");
        } else {
            // Update Existing
            // Keep old image if new one is empty but user didn't clear it explicitly (simplified logic here: assume tempImageBase64 holds current state)
            storeData.products[idx] = productObj;
            toastr.success("Produk Diupdate!");
        }
        
        try {
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            window.cancelEdit(); // Reset Form
            renderAdminList();
            renderStore();
        } catch(e) { toastr.error("Error Saving"); }
    };

    window.delProd = async (i) => {
        if(confirm("Hapus produk ini?")) {
            storeData.products.splice(i, 1);
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            renderAdminList(); renderStore();
            if(document.getElementById('editProdIndex').value == i) window.cancelEdit();
        }
    };
    window.saveSettings = async () => { storeData.name=document.getElementById('setStoreName').value; storeData.fee=parseInt(document.getElementById('setFee').value)||0; storeData.qris=document.getElementById('setQris').value; await update(ref(db, `stores/${STORE_ID}`), storeData); toastr.success("Settings Saved"); setTimeout(()=>location.reload(),1000); };
    
    // Global Expose
    window.showProfile=window.showProfile; window.saveProfile=window.saveProfile; window.logout=window.logout; window.loginGoogle=window.loginGoogle; window.loginGuest=window.loginGuest;
    window.toggleCart=window.toggleCart; window.addToCart=window.addToCart; window.updateQty=window.updateQty; window.processCheckout=window.processCheckout; window.closePayment=window.closePayment; window.sendOrder=window.sendOrder;
    window.showProductDetail=window.showProductDetail; window.closeProductDetail=window.closeProductDetail; window.addToCartFromDetail=window.addToCartFromDetail; window.buyNowFromDetail=window.buyNowFromDetail;
    window.loginAdmin=window.loginAdmin; window.saveSettings=window.saveSettings; 
    window.handleImageUpload=window.handleImageUpload; window.saveProduct=window.saveProduct; window.editProd=window.editProd; window.delProd=window.delProd; window.cancelEdit=window.cancelEdit;

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Itsbad Store - Premium Digital Shop</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
    
    body { 
        font-family: 'Outfit', sans-serif; 
        background-color: #f8fafc; 
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
    }
    
    .loader { border: 3px solid #e2e8f0; border-radius: 50%; border-top: 3px solid #4f46e5; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    #qrContainer img { margin: 0 auto; border: 8px solid white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    
    .glass-nav { 
        background: rgba(255, 255, 255, 0.85); 
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    }

    .slide-up-enter { transform: translateY(100%); opacity: 0; }
    .slide-up-active { transform: translateY(0); opacity: 1; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    
    .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); }
    
    .product-card { transition: all 0.3s ease; }
    .product-card:active { transform: scale(0.98); }
    
    #toast-container > div { opacity: 1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 12px; }
  </style>
</head>
<body class="flex justify-center min-h-screen text-slate-800">

  <div class="w-full max-w-md bg-white/80 shadow-[0_20px_50px_rgba(8,_112,_184,_0.1)] min-h-screen relative flex flex-col overflow-hidden backdrop-blur-sm border-x border-white/50">
    
    <div class="glass-nav px-5 py-4 z-50 sticky top-0 flex justify-between items-center h-20">
        <div class="flex items-center gap-3">
            <div onclick="window.showProfile()" class="cursor-pointer group">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-slate-100 ring-2 ring-white shadow-sm flex items-center justify-center overflow-hidden transition group-hover:scale-105">
                    <i class="fas fa-user text-slate-400"></i>
                </div>
            </div>
            <div class="flex flex-col">
                <h1 class="text-base font-bold leading-tight tracking-tight text-slate-800" id="shopNameDisplay">Itsbad Store</h1>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-[11px] font-medium text-slate-500 truncate max-w-[120px]" id="userNameDisplay">Menunggu Login...</p>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="window.toggleCart()" class="relative p-3 bg-white rounded-xl shadow-sm text-slate-600 hover:text-indigo-600 hover:shadow-md transition border border-slate-100 group">
                <i class="fas fa-shopping-bag text-lg transition group-hover:scale-110"></i>
                <span id="cartCount" class="absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-white hidden shadow-sm">0</span>
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 relative no-scrollbar pb-24" id="mainContainer">

      <div class="mb-6 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 p-6 text-white shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10 blur-xl"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-yellow-400 opacity-20 rounded-full -ml-10 -mb-10 blur-xl"></div>
        <h2 class="font-bold text-xl mb-1 relative z-10">Premium Digital</h2>
        <p class="text-indigo-100 text-xs relative z-10">Paket Internet, VPN & Akun Premium Termurah & Terpercaya.</p>
      </div>

      <div id="authOverlay" class="fixed inset-0 bg-white/95 backdrop-blur-md z-[60] flex flex-col items-center justify-center p-8 hidden transition-opacity duration-300">
          <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-3xl flex items-center justify-center mb-8 shadow-xl shadow-indigo-200 rotate-3 hover:rotate-6 transition">
              <i class="fas fa-bolt text-4xl text-white"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2 text-slate-800">Selamat Datang</h2>
          <p class="text-slate-500 text-sm mb-10 text-center leading-relaxed">Nikmati kemudahan belanja produk digital dengan pembayaran Qris.</p>
          
          <button onclick="window.loginGoogle()" class="w-full bg-white border border-slate-200 py-4 rounded-2xl font-bold text-slate-700 flex items-center justify-center gap-3 shadow-sm hover:bg-slate-50 hover:shadow-md transition mb-3 group">
              <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5 group-hover:scale-110 transition"> Masuk dengan Google
          </button>
          
          <button onclick="window.loginGuest()" class="w-full bg-slate-100 py-4 rounded-2xl font-bold text-slate-600 hover:bg-slate-200 transition">
              Lanjut sebagai Tamu
          </button>
      </div>

      <div id="page-shop">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-slate-800">Produk Terbaru</h3>
            <span class="text-xs text-indigo-600 font-semibold bg-indigo-50 px-2 py-1 rounded-lg">All Items</span>
        </div>

        <div id="productGrid" class="grid grid-cols-2 gap-4 pb-24">
            <div class="col-span-2 text-center py-20 text-slate-400">
                <div class="loader mx-auto mb-3"></div> Memuat Produk...
            </div>
        </div>
      </div>
    </div>

    <div id="cartModal" class="fixed inset-0 z-50 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity duration-300 backdrop-blur-sm" id="cartBackdrop" onclick="window.toggleCart()"></div>
        <div class="absolute bottom-0 left-0 w-full bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) pointer-events-auto max-h-[85vh] flex flex-col" id="cartSheet">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-xl text-slate-800">Keranjang</h3>
                </div>
                <button onclick="window.toggleCart()" class="w-9 h-9 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="cartItems" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar min-h-[200px] bg-slate-50/50"></div>
            <div class="p-6 bg-white border-t border-slate-100">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-500">Subtotal</span>
                    <span class="font-bold text-slate-800" id="cartSubtotal">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm mb-4">
                    <span class="text-slate-500">Fee</span>
                    <span class="font-bold text-indigo-600" id="cartFee">+ Rp 0</span>
                </div>
                <div class="flex justify-between items-end mb-6">
                    <span class="text-slate-800 font-bold">Total Pembayaran</span>
                    <span class="text-2xl font-bold text-indigo-600 leading-none" id="cartTotal">Rp 0</span>
                </div>
                <button onclick="window.processCheckout()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 hover:scale-[1.02] transition active:scale-95">
                    BAYAR SEKARANG <i class="fas fa-arrow-right ml-2 text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-white z-[60] hidden flex-col">
        <div class="p-5 border-b flex items-center gap-4 bg-white sticky top-0 z-10">
            <button onclick="window.closePayment()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-bold text-lg">Pembayaran</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6 text-center bg-slate-50/50">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-violet-500"></div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">Total Tagihan Anda</p>
                <h1 class="text-4xl font-extrabold text-slate-800" id="payTotal">Rp 0</h1>
            </div>
            <div class="bg-white border border-slate-200 p-6 rounded-3xl mb-6 shadow-sm">
                <p class="text-xs font-bold text-slate-400 mb-4 tracking-wide">SCAN QRIS PEMBAYARAN</p>
                <div id="qrContainer" class="flex justify-center min-h-[220px] items-center py-2">
                    <p class="text-xs text-slate-300 animate-pulse">Memuat QRIS...</p>
                </div>
                <div class="mt-4 bg-orange-50 border border-orange-100 text-orange-600 px-3 py-2 rounded-lg text-[10px] inline-block font-medium" id="qrNote">
                   <i class="fas fa-bolt mr-1"></i> Nominal otomatis
                </div>
            </div>
            <div class="text-left mb-6">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">Nama Pembeli</label>
                <input type="text" id="custName" class="w-full p-4 border border-slate-200 rounded-2xl bg-white text-slate-600 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-100" readonly>
            </div>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex gap-3 items-start text-left shadow-sm">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600 mt-1">
                    <i class="fas fa-info text-sm"></i>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-blue-900 mb-1">Konfirmasi Pembayaran</h4>
                    <p class="text-xs text-blue-700 leading-relaxed">
                        Silakan lakukan pembayaran sesuai nominal. Setelah itu klik tombol di bawah untuk <b>mengirim bukti transfer</b> ke WhatsApp Admin.
                    </p>
                </div>
            </div>
        </div>
        <div class="p-5 border-t bg-white pb-8">
            <button onclick="window.sendOrder()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-2xl"></i> KONFIRMASI VIA WHATSAPP
            </button>
        </div>
    </div>

    <div id="productDetailModal" class="fixed inset-0 modal-overlay z-[80] hidden items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white rounded-t-[2rem] sm:rounded-3xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto no-scrollbar transform transition-transform duration-300" id="detailCard">
            <div class="relative">
                <div class="absolute top-4 right-4 z-10">
                    <button onclick="window.closeProductDetail()" class="w-9 h-9 bg-white/80 backdrop-blur rounded-full flex items-center justify-center text-slate-800 shadow-sm hover:bg-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="detailImageContainer" class="w-full h-64 bg-slate-100 flex items-center justify-center overflow-hidden">
                   </div>
            </div>
            <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-0">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <div class="flex items-start justify-between mb-2">
                    <h1 id="detailName" class="text-2xl font-bold text-slate-800 leading-tight">Nama Produk</h1>
                </div>
                <div class="flex items-center gap-3 mb-6">
                    <p id="detailPrice" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">Rp 0</p>
                    <div class="h-6 w-[1px] bg-slate-200"></div>
                    <p id="detailStock" class="text-sm font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-md">Stok: 0</p>
                </div>
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-slate-900 mb-2">Deskripsi</h3>
                    <p id="detailDescription" class="text-slate-500 text-sm leading-relaxed">Deskripsi produk akan muncul di sini.</p>
                </div>
                <div class="flex gap-3 sticky bottom-0 bg-white pt-2 pb-4 border-t border-slate-50">
                    <button id="detailAddToCart" onclick="window.addToCartFromDetail()" class="flex-1 bg-white border-2 border-slate-900 text-slate-900 py-4 rounded-2xl font-bold hover:bg-slate-50 transition">
                        TAMBAH
                    </button>
                    <button onclick="window.buyNowFromDetail()" class="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 transition">
                        BELI SEKARANG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-white/95 backdrop-blur-sm z-[70] hidden flex-col overflow-y-auto">
        <div class="sticky top-0 bg-white/80 backdrop-blur-md p-5 border-b border-slate-100 flex justify-between items-center z-10">
            <h2 class="font-bold text-lg">Edit Profil</h2>
            <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="w-9 h-9 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 max-w-md mx-auto w-full">
            <div class="flex flex-col items-center mb-8">
                <div class="relative group">
                    <div id="profileAvatar" class="w-28 h-28 rounded-full bg-slate-100 flex items-center justify-center overflow-hidden border-4 border-white shadow-xl">
                        <i class="fas fa-user text-slate-300 text-4xl"></i>
                    </div>
                    <label for="avatarUpload" class="absolute bottom-0 right-0 w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white cursor-pointer shadow-lg hover:bg-indigo-600 transition hover:scale-110">
                        <i class="fas fa-camera text-sm"></i>
                    </label>
                    <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                </div>
                <h3 class="font-bold text-xl mt-4 text-slate-800" id="profileName">Loading...</h3>
                <p class="text-sm text-slate-400" id="profileEmail">Loading...</p>
            </div>
            <div class="space-y-5">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Nama Lengkap</label>
                        <input type="text" id="editName" class="w-full p-4 border border-slate-200 rounded-2xl bg-white mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" placeholder="Nama Anda">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Nomor WhatsApp</label>
                        <div class="flex gap-2 mt-1">
                            <div class="flex items-center px-4 bg-slate-50 border border-slate-200 rounded-2xl">
                                <span class="text-slate-600 font-bold font-mono text-sm">ðŸ‡®ðŸ‡© +62</span>
                            </div>
                            <input type="tel" id="editPhone" class="flex-1 p-4 border border-slate-200 rounded-2xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" placeholder="8123xxxxx">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 ml-1">Alamat (Opsional)</label>
                        <textarea id="editAddress" class="w-full p-4 border border-slate-200 rounded-2xl bg-white mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-100 transition" rows="2" placeholder="Kota/Email untuk pengiriman"></textarea>
                    </div>
                </div>
                <div class="bg-amber-50 p-5 rounded-2xl border border-amber-100">
                    <h4 class="font-bold text-sm text-amber-800 mb-3 flex items-center"><i class="fas fa-history mr-2"></i>Riwayat Transaksi Terakhir</h4>
                    <div id="orderHistory" class="text-sm space-y-2">
                        <p class="text-center py-2 text-amber-600/70 italic text-xs">Belum ada riwayat</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-3 pb-10">
                <button onclick="window.saveProfile()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-800 transition">SIMPAN PERUBAHAN</button>
                <button onclick="window.logout()" class="w-full bg-white border border-slate-200 text-red-500 py-4 rounded-2xl font-bold hover:bg-red-50 transition">KELUAR AKUN</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="fixed inset-0 bg-slate-100 z-[90] hidden overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 shadow-sm flex justify-between items-center z-10 border-b">
            <h2 class="font-bold text-lg">Admin Dashboard</h2>
            <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-xs font-bold bg-red-100 text-red-600 px-3 py-2 rounded-lg">Tutup</button>
        </div>
        
        <div id="adminLoginForm" class="p-10 text-center mt-20">
            <div class="w-20 h-20 bg-slate-800 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl rotate-3">
                <i class="fas fa-shield-alt text-white text-3xl"></i>
            </div>
            <h3 class="font-bold text-xl mb-6 text-slate-800">Verifikasi Admin</h3>
            <input type="password" id="adminPin" class="w-full p-4 rounded-2xl border-none ring-1 ring-slate-200 text-center text-2xl mb-6 bg-white shadow-sm focus:ring-2 focus:ring-slate-800 outline-none" placeholder="******" maxlength="6">
            <button onclick="window.loginAdmin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-800 transition">MASUK DASHBOARD</button>
        </div>

        <div id="adminContent" class="p-5 space-y-6 hidden max-w-lg mx-auto">
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider">Konfigurasi Toko</h3>
                <input type="text" id="setStoreName" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" value="Itsbad Store" placeholder="Nama Toko">
                <input type="number" id="setFee" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-3 text-sm" placeholder="Biaya Admin (Rp)">
                
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-3">
                    <p class="text-[10px] font-bold text-blue-600 mb-1">Upload QRIS Merchant</p>
                    <p class="text-[10px] text-blue-500 leading-tight">Gunakan QRIS dari Dana Bisnis/Shopee agar nominal otomatis.</p>
                </div>
                <input type="file" id="qrisUpload" class="text-xs w-full mb-2">
                <textarea id="setQris" class="w-full p-3 text-[10px] bg-slate-900 text-green-400 rounded-xl font-mono mb-4" rows="2" readonly placeholder="String QRIS..."></textarea>
                <button onclick="window.saveSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200">SIMPAN PENGATURAN</button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider" id="formTitle">Tambah Produk Baru</h3>
                
                <input type="hidden" id="editProdIndex" value="-1">

                <div class="mb-4 text-center">
                    <div id="previewContainer" class="w-24 h-24 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 mx-auto flex items-center justify-center overflow-hidden relative group cursor-pointer" onclick="document.getElementById('prodImageUpload').click()">
                        <img id="imgPreview" class="hidden w-full h-full object-cover">
                        <div id="imgPlaceholder" class="text-slate-400 flex flex-col items-center">
                            <i class="fas fa-camera mb-1"></i>
                            <span class="text-[10px]">Foto</span>
                        </div>
                    </div>
                    <input type="file" id="prodImageUpload" accept="image/*" class="hidden" onchange="window.handleImageUpload(this)">
                    <p class="text-[10px] text-slate-400 mt-2">Klik kotak untuk upload foto</p>
                </div>

                <input type="text" id="newProdName" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-slate-50 focus:bg-white transition" placeholder="Nama Produk">
                <div class="flex gap-3 mb-3">
                    <input type="number" id="newProdPrice" class="w-1/2 p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white" placeholder="Harga (Rp)">
                    <input type="number" id="newProdStock" class="w-1/2 p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white" placeholder="Stok">
                </div>
                <textarea id="newProdDesc" class="w-full p-3 border border-slate-200 rounded-xl mb-4 text-sm bg-slate-50 focus:bg-white" placeholder="Deskripsi Singkat" rows="3"></textarea>
                
                <div class="flex gap-2">
                    <button onclick="window.cancelEdit()" id="btnCancelEdit" class="hidden w-1/3 bg-slate-200 text-slate-600 py-3 rounded-xl text-sm font-bold">BATAL</button>
                    <button onclick="window.saveProduct()" id="btnSaveProd" class="flex-1 bg-green-500 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-200">PUBLISH PRODUK</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider">Katalog Produk</h3>
                <div id="adminProdList" class="space-y-2 max-h-80 overflow-y-auto pr-1"></div>
            </div>
            
            <div class="h-10"></div>
        </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
      measurementId: "G-QR6HPRX459"
    };

    const STORE_ID = "itsbad-store";
    const OWNER_WA = "6285236363128";

    // Init Variables
    let db, auth, user;
    let storeData = { name: "Itsbad Store", fee: 0, products: [] };
    let cart = JSON.parse(localStorage.getItem('myCart')) || [];
    let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
    let currentProductDetail = null;
    let tempImageBase64 = ""; // Variable to hold uploaded image string
    
    toastr.options = { 
        "positionClass": "toast-top-center", 
        "timeOut": "2000",
        "showMethod": "slideDown",
        "hideMethod": "slideUp",
        "closeButton": false,
        "progressBar": true
    };

    const urlParams = new URLSearchParams(window.location.search);
    const isAdminPage = urlParams.get('page') === 'admin';

    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('authOverlay').classList.add('opacity-0');
                setTimeout(() => document.getElementById('authOverlay').classList.add('hidden'), 300);
                loadUserProfile(u.uid);
                initStore();
                if(isAdminPage) setTimeout(() => document.getElementById('adminPanel').classList.remove('hidden'), 500);
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('authOverlay').classList.remove('opacity-0');
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });
    } catch(e) { console.error(e); alert("Firebase Config Error: " + e.message); }

    // --- USER & AUTH FUNCTIONS ---
    async function loadUserProfile(uid) {
        try {
            const snap = await get(child(ref(db), `users/${uid}`));
            if(snap.exists()) {
                userProfile = snap.val();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                loadOrderHistory(uid);
            } else {
                userProfile = { name: user.displayName || "Pelanggan Baru", email: user.email || "", phone: "", address: "", avatar: user.photoURL || "", createdAt: Date.now() };
                await set(ref(db, `users/${uid}`), userProfile);
            }
        } catch(e) { console.log("Using local profile"); }
    }

    function updateProfileDisplay() {
        document.getElementById('userNameDisplay').innerText = userProfile.name || "Pelanggan";
        const avatarEl = document.getElementById('userAvatar');
        const imgUrl = (userProfile.avatar && userProfile.avatar !== "local") ? userProfile.avatar : user.photoURL;
        if(imgUrl) avatarEl.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
        
        document.getElementById('profileName').innerText = userProfile.name || "Pelanggan";
        document.getElementById('profileEmail').innerText = userProfile.email || "";
        document.getElementById('editName').value = userProfile.name || "";
        document.getElementById('editPhone').value = userProfile.phone || "";
        document.getElementById('editAddress').value = userProfile.address || "";
        
        const profileAvatar = document.getElementById('profileAvatar');
        if(imgUrl) profileAvatar.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
    }

    window.saveProfile = async () => {
        const newName = document.getElementById('editName').value;
        const newPhone = document.getElementById('editPhone').value;
        const newAddress = document.getElementById('editAddress').value;
        if(!newName.trim()) return toastr.warning("Nama tidak boleh kosong");
        
        userProfile.name = newName;
        userProfile.phone = newPhone;
        userProfile.address = newAddress;
        
        try {
            await update(ref(db, `users/${user.uid}`), userProfile);
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            toastr.success("Profil tersimpan!");
            setTimeout(() => document.getElementById('profileModal').classList.add('hidden'), 500);
        } catch(e) { toastr.error("Gagal menyimpan profil"); }
    };

    document.getElementById('avatarUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        if(file.size > 2 * 1024 * 1024) return toastr.warning("Ukuran maksimal 2MB");
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            userProfile.avatar = ev.target.result;
            try {
                await update(ref(db, `users/${user.uid}`), { avatar: userProfile.avatar });
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                toastr.success("Foto profil diupdate!");
            } catch(e) { toastr.error("Gagal update foto"); }
        };
        reader.readAsDataURL(file);
    });

    async function loadOrderHistory(uid) {
        try {
            const snap = await get(child(ref(db), `orders/${uid}`));
            if(snap.exists()) {
                const orders = snap.val();
                let html = '<div class="space-y-3">';
                Object.entries(orders).reverse().slice(0, 5).forEach(([key, order]) => {
                    const date = new Date(order.timestamp || key).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                    html += `<div class="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex justify-between items-center"><div class="overflow-hidden"><p class="text-[10px] text-slate-400 mb-1">${date}</p><p class="text-xs font-bold text-slate-700 truncate w-32">${order.items.split(',')[0]}</p></div><span class="font-bold text-amber-600 text-sm">Rp ${parseInt(order.total || 0).toLocaleString()}</span></div>`;
                });
                document.getElementById('orderHistory').innerHTML = html + '</div>';
            }
        } catch(e) { console.log("No history"); }
    }

    // --- STORE ---
    async function initStore() {
        try {
            const snap = await get(child(ref(db), `stores/${STORE_ID}`));
            if(snap.exists()) {
                storeData = snap.val();
                if(!storeData.products) storeData.products = [];
            } else {
                storeData = { name: "Itsbad Store", fee: 0, products: [] };
                await set(ref(db, `stores/${STORE_ID}`), storeData);
            }
            renderStore();
        } catch(e) { console.error(e); renderStore(); }
    }

    function renderStore() {
        document.getElementById('shopNameDisplay').innerText = storeData.name || "Itsbad Store";
        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";
        
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                const hasStock = parseInt(p.stock) > 0;
                // Check if product has image, else use default icon
                const imgDisplay = p.image 
                    ? `<img src="${p.image}" class="w-full h-full object-cover transition duration-300 group-hover:scale-110">`
                    : `<i class="fas fa-cube text-4xl group-hover:scale-110 transition duration-300 text-indigo-200"></i>`;
                
                const bgClass = p.image ? "bg-slate-100" : "bg-gradient-to-br from-indigo-50 to-blue-50";

                grid.innerHTML += `
                <div class="product-card bg-white p-4 rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-white flex flex-col h-full relative overflow-hidden group cursor-pointer fade-in" onclick="window.showProductDetail(${i})" style="animation-delay: ${i*0.1}s">
                    ${!hasStock ? '<div class="absolute inset-0 bg-white/60 backdrop-blur-[2px] flex items-center justify-center font-bold text-red-500 z-10 text-sm border-2 border-red-100 rounded-3xl m-2">HABIS</div>' : ''}
                    <div class="w-full aspect-square ${bgClass} rounded-2xl mb-4 flex items-center justify-center overflow-hidden shadow-inner">
                        ${imgDisplay}
                    </div>
                    <h3 class="font-bold text-sm text-slate-800 leading-tight mb-1 truncate">${p.name}</h3>
                    <p class="text-xs text-slate-400 mb-3 truncate">${p.desc || 'No Description'}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <p class="font-extrabold text-indigo-600 text-sm">Rp ${parseInt(p.price).toLocaleString()}</p>
                        <button onclick="event.stopPropagation(); window.addToCart(${i})" class="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-200 transition disabled:bg-slate-200" ${!hasStock ? 'disabled':''}>
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
        } else {
            grid.innerHTML = `<div class="col-span-2 text-center text-slate-400 py-10">Belum ada produk.</div>`;
        }
        updateCartBadge();
    }

    // --- PRODUCT DETAIL ---
    window.showProductDetail = (index) => {
        currentProductDetail = index;
        const p = storeData.products[index];
        document.getElementById('detailName').innerText = p.name;
        document.getElementById('detailPrice').innerText = `Rp ${parseInt(p.price).toLocaleString()}`;
        document.getElementById('detailStock').innerText = `Stok: ${p.stock}`;
        document.getElementById('detailDescription').innerText = p.desc || 'Tidak ada deskripsi';
        
        const imgContainer = document.getElementById('detailImageContainer');
        if(p.image) {
            imgContainer.innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
        } else {
            imgContainer.innerHTML = `<i class="fas fa-cube text-8xl opacity-20 text-indigo-500"></i>`;
        }

        const addBtn = document.getElementById('detailAddToCart');
        const hasStock = parseInt(p.stock) > 0;
        addBtn.disabled = !hasStock;
        addBtn.innerHTML = hasStock ? '<i class="fas fa-cart-plus mr-2"></i> TAMBAH' : 'HABIS';
        addBtn.className = hasStock ? "flex-1 bg-white border-2 border-slate-900 text-slate-900 py-4 rounded-2xl font-bold hover:bg-slate-50 transition" : "flex-1 bg-slate-100 text-slate-400 border-2 border-slate-200 py-4 rounded-2xl font-bold cursor-not-allowed";

        const modal = document.getElementById('productDetailModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        const card = document.getElementById('detailCard');
        card.classList.add('translate-y-full');
        setTimeout(() => card.classList.remove('translate-y-full'), 50);
    };

    window.closeProductDetail = () => {
        const card = document.getElementById('detailCard');
        card.classList.add('translate-y-full');
        setTimeout(() => document.getElementById('productDetailModal').classList.add('hidden'), 300);
    };

    window.addToCartFromDetail = () => { if(currentProductDetail !== null) { window.addToCart(currentProductDetail); window.closeProductDetail(); } };
    window.buyNowFromDetail = () => { if(currentProductDetail !== null) { const p = storeData.products[currentProductDetail]; if(parseInt(p.stock)>0) { const exist=cart.find(c=>c.index===currentProductDetail); if(!exist) { cart.push({index:currentProductDetail, name:p.name, price:parseInt(p.price), qty:1, stock:parseInt(p.stock)}); saveCart(); } window.closeProductDetail(); window.toggleCart(); } else toastr.warning("Stok Habis"); } };

    // --- CART ---
    window.addToCart = (index) => {
        const p = storeData.products[index];
        const exist = cart.find(c => c.index === index);
        if(exist) { if(exist.qty < p.stock) exist.qty++; else return toastr.warning("Stok maksimal!"); } 
        else cart.push({ index, name: p.name, price: parseInt(p.price), qty: 1, stock: parseInt(p.stock) });
        saveCart();
        toastr.success("Masuk keranjang!");
    };
    window.updateQty = (idx, change) => {
        if(cart[idx].qty + change > 0 && cart[idx].qty + change <= cart[idx].stock) cart[idx].qty += change;
        else if (cart[idx].qty + change <= 0 && confirm("Hapus item?")) cart.splice(idx, 1);
        saveCart();
    };
    function saveCart() { localStorage.setItem('myCart', JSON.stringify(cart)); updateCartBadge(); renderCart(); }
    function updateCartBadge() { const c = cart.reduce((a,b)=>a+b.qty,0); const el=document.getElementById('cartCount'); el.innerText=c; c>0?el.classList.remove('hidden'):el.classList.add('hidden'); }
    function renderCart() {
        const el = document.getElementById('cartItems'); el.innerHTML = ""; let sub = 0;
        if(cart.length===0) el.innerHTML = `<div class="text-center text-slate-400 py-12">Keranjang kosong</div>`;
        else cart.forEach((c,i) => { sub+=c.price*c.qty; el.innerHTML+=`<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-200 shadow-sm"><div class="flex-1"><h4 class="font-bold text-sm text-slate-800">${c.name}</h4><p class="text-xs text-indigo-600 font-bold mt-1">Rp ${c.price.toLocaleString()}</p></div><div class="flex items-center gap-3 bg-slate-50 rounded-xl p-1 border border-slate-100"><button onclick="window.updateQty(${i},-1)" class="w-7 h-7 flex items-center justify-center font-bold">-</button><span class="text-sm font-bold w-4 text-center">${c.qty}</span><button onclick="window.updateQty(${i},1)" class="w-7 h-7 flex items-center justify-center font-bold">+</button></div></div>`; });
        const fee = parseInt(storeData.fee||0);
        document.getElementById('cartSubtotal').innerText="Rp "+sub.toLocaleString();
        document.getElementById('cartFee').innerText="+ Rp "+fee.toLocaleString();
        document.getElementById('cartTotal').innerText="Rp "+(sub+fee).toLocaleString();
    }
    window.toggleCart = () => { const m=document.getElementById('cartBackdrop'); const s=document.getElementById('cartSheet'); if(s.classList.contains('translate-y-full')) { renderCart(); m.parentElement.classList.remove('pointer-events-none'); m.classList.remove('opacity-0'); s.classList.remove('translate-y-full'); } else { m.parentElement.classList.add('pointer-events-none'); m.classList.add('opacity-0'); s.classList.add('translate-y-full'); } };

    // --- CHECKOUT ---
    window.processCheckout = () => {
        if(cart.length===0) return toastr.warning("Keranjang kosong!");
        if(user.isAnonymous && !userProfile.phone) { toastr.warning("Isi No. WA dulu!"); window.showProfile(); window.toggleCart(); return; }
        window.toggleCart();
        const tot = cart.reduce((a,b)=>a+b.qty*b.price,0) + parseInt(storeData.fee||0);
        document.getElementById('payTotal').innerText="Rp "+tot.toLocaleString();
        document.getElementById('custName').value=userProfile.name||"Pelanggan";
        document.getElementById('paymentModal').classList.remove('hidden');
        document.getElementById('paymentModal').classList.add('flex');
        generateQR(tot);
    };
    window.closePayment = () => { document.getElementById('paymentModal').classList.add('hidden'); document.getElementById('paymentModal').classList.remove('flex'); };
    function generateQR(amount) {
        const c = document.getElementById('qrContainer'); c.innerHTML = "";
        let q = storeData.qris; const n = document.getElementById('qrNote');
        if(!q) { c.innerHTML = "<div class='text-center text-xs text-red-500'>QRIS belum diset</div>"; return; }
        if(q.startsWith("http")||q.length<50) { n.innerHTML="Input Nominal Manual"; n.className="mt-4 bg-orange-50 text-orange-600 px-3 py-2 rounded-lg text-[10px]"; }
        else { try { q = injectAmount(q, amount); n.innerHTML="Nominal Otomatis"; n.className="mt-4 bg-green-50 text-green-600 px-3 py-2 rounded-lg text-[10px]"; } catch(e){} }
        new QRCode(c, { text: q, width: 180, height: 180 });
    }
    function injectAmount(p, a) {
        let raw = p.slice(0,-4).replace("010211","010212"); const s=a+".00"; const t="54"+s.length.toString().padStart(2,'0')+s;
        raw = raw.includes("5802ID") ? raw.replace(/(5802ID.*?)(?=59)/, "$1"+t) : raw+t; // Simplified injection logic
        return raw + crc16(raw);
    }
    function crc16(s) { let crc=0xFFFF; for(let i=0;i<s.length;i++) { crc^=s.charCodeAt(i)<<8; for(let j=0;j<8;j++) crc=(crc&0x8000)?(crc<<1)^0x1021:crc<<1; } return (crc&0xFFFF).toString(16).toUpperCase().padStart(4,'0'); }

    window.sendOrder = async () => {
        let list=""; cart.forEach(c=>list+=`â–ªï¸ ${c.name} (${c.qty}x)\n`);
        const sub = cart.reduce((a,b)=>a+b.qty*b.price,0); const fee=parseInt(storeData.fee||0); const tot=sub+fee;
        const msg = `*ORDER BARU - ITSBAD STORE*\nðŸ‘¤ ${userProfile.name}\nðŸ“± ${userProfile.phone?'+62'+userProfile.phone:'-'}\n\n*Pesanan:*\n${list}Total: Rp ${tot.toLocaleString()}\n\nMohon dicek pembayaran saya.`;
        try { await push(ref(db, `orders/${user.uid}`), { user:user.uid, userName:userProfile.name, items:cart.map(c=>`${c.name} (${c.qty}x)`).join(','), total:tot, timestamp:Date.now(), status:"pending" }); } catch(e){}
        window.open(`https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`, '_blank');
        cart=[]; saveCart(); setTimeout(()=>window.location.reload(),2000);
    };

    // --- ADMIN LOGIC (NEW: EDIT & IMAGE UPLOAD) ---
    window.loginAdmin = () => { if(document.getElementById('adminPin').value==="110603") { document.getElementById('adminLoginForm').classList.add('hidden'); document.getElementById('adminContent').classList.remove('hidden'); loadAdminData(); } else toastr.error("PIN Salah"); };
    
    function loadAdminData() {
        document.getElementById('setStoreName').value = storeData.name;
        document.getElementById('setFee').value = storeData.fee;
        document.getElementById('setQris').value = storeData.qris || "";
        renderAdminList();
    }

    // 1. Handle Image Upload & Compress to Base64
    window.handleImageUpload = (input) => {
        const file = input.files[0];
        if(!file) return;
        
        // Loader / UI Feedback
        document.getElementById('imgPlaceholder').innerHTML = '<div class="loader"></div>';
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // Compress Logic: Max Width 300px
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 300; 
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to Base64 string (low quality to save DB space)
                tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // Preview
                const preview = document.getElementById('imgPreview');
                preview.src = tempImageBase64;
                preview.classList.remove('hidden');
                document.getElementById('imgPlaceholder').classList.add('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    // 2. Render Admin List with Edit Button
    function renderAdminList() {
        const el = document.getElementById('adminProdList'); el.innerHTML = "";
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                el.innerHTML += `
                <div class="flex justify-between p-3 bg-slate-50 rounded-xl border border-slate-200 mb-2 items-center">
                    <div class="flex items-center gap-3 w-1/2">
                        <div class="w-8 h-8 rounded bg-slate-200 overflow-hidden flex-shrink-0">
                             ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-xs text-slate-400"><i class="fas fa-box"></i></div>'}
                        </div>
                        <div class="overflow-hidden">
                            <span class="text-xs truncate font-bold text-slate-700 block">${p.name}</span>
                            <span class="text-[10px] text-slate-400">Stok: ${p.stock}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="text-xs text-indigo-600 font-bold mr-2">Rp ${parseInt(p.price).toLocaleString()}</span>
                         <button onclick="window.editProd(${i})" class="text-blue-500 w-7 h-7 rounded-full bg-blue-50 hover:bg-blue-100 flex items-center justify-center transition"><i class="fas fa-pencil text-xs"></i></button>
                         <button onclick="window.delProd(${i})" class="text-red-500 w-7 h-7 rounded-full bg-red-50 hover:bg-red-100 flex items-center justify-center transition"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`;
            });
        } else el.innerHTML = '<p class="text-center text-xs text-slate-400 italic">Kosong</p>';
    }

    // 3. Edit Logic
    window.editProd = (i) => {
        const p = storeData.products[i];
        document.getElementById('formTitle').innerText = "Edit Produk";
        document.getElementById('editProdIndex').value = i; // Set Index
        
        document.getElementById('newProdName').value = p.name;
        document.getElementById('newProdPrice').value = p.price;
        document.getElementById('newProdStock').value = p.stock;
        document.getElementById('newProdDesc').value = p.desc;
        
        // Handle Image Preview
        if(p.image) {
            tempImageBase64 = p.image;
            document.getElementById('imgPreview').src = p.image;
            document.getElementById('imgPreview').classList.remove('hidden');
            document.getElementById('imgPlaceholder').classList.add('hidden');
        } else {
            resetImagePreview();
        }

        // Change Button State
        document.getElementById('btnSaveProd').innerText = "UPDATE PRODUK";
        document.getElementById('btnSaveProd').classList.replace('bg-green-500', 'bg-blue-600');
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        
        // Scroll to form
        document.getElementById('formTitle').scrollIntoView({behavior: 'smooth'});
    };

    window.cancelEdit = () => {
        document.getElementById('formTitle').innerText = "Tambah Produk Baru";
        document.getElementById('editProdIndex').value = "-1";
        document.getElementById('newProdName').value = "";
        document.getElementById('newProdPrice').value = "";
        document.getElementById('newProdStock').value = "";
        document.getElementById('newProdDesc').value = "";
        resetImagePreview();
        
        document.getElementById('btnSaveProd').innerText = "PUBLISH PRODUK";
        document.getElementById('btnSaveProd').classList.replace('bg-blue-600', 'bg-green-500');
        document.getElementById('btnCancelEdit').classList.add('hidden');
    };

    function resetImagePreview() {
        tempImageBase64 = "";
        document.getElementById('prodImageUpload').value = "";
        document.getElementById('imgPreview').classList.add('hidden');
        document.getElementById('imgPlaceholder').classList.remove('hidden');
        document.getElementById('imgPlaceholder').innerHTML = '<i class="fas fa-camera mb-1"></i><span class="text-[10px]">Foto</span>';
    }

    // 4. Save (Add or Update)
    window.saveProduct = async () => {
        const idx = parseInt(document.getElementById('editProdIndex').value);
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const stock = document.getElementById('newProdStock').value;
        const desc = document.getElementById('newProdDesc').value;

        if(!name || !price) return toastr.warning("Nama dan Harga wajib diisi");

        const productObj = {
            name, 
            price: parseInt(price) || 0,
            stock: parseInt(stock) || 0,
            desc: desc || "",
            image: tempImageBase64 || "" // Save image string
        };

        if(!storeData.products) storeData.products = [];

        if(idx === -1) {
            // Add New
            storeData.products.push(productObj);
            toastr.success("Produk Ditambah!");
        } else {
            // Update Existing
            // Keep old image if new one is empty but user didn't clear it explicitly (simplified logic here: assume tempImageBase64 holds current state)
            storeData.products[idx] = productObj;
            toastr.success("Produk Diupdate!");
        }
        
        try {
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            window.cancelEdit(); // Reset Form
            renderAdminList();
            renderStore();
        } catch(e) { toastr.error("Error Saving"); }
    };

    window.delProd = async (i) => {
        if(confirm("Hapus produk ini?")) {
            storeData.products.splice(i, 1);
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            renderAdminList(); renderStore();
            if(document.getElementById('editProdIndex').value == i) window.cancelEdit();
        }
    };
    window.saveSettings = async () => { storeData.name=document.getElementById('setStoreName').value; storeData.fee=parseInt(document.getElementById('setFee').value)||0; storeData.qris=document.getElementById('setQris').value; await update(ref(db, `stores/${STORE_ID}`), storeData); toastr.success("Settings Saved"); setTimeout(()=>location.reload(),1000); };
    
    // Global Expose
    window.showProfile=window.showProfile; window.saveProfile=window.saveProfile; window.logout=window.logout; window.loginGoogle=window.loginGoogle; window.loginGuest=window.loginGuest;
    window.toggleCart=window.toggleCart; window.addToCart=window.addToCart; window.updateQty=window.updateQty; window.processCheckout=window.processCheckout; window.closePayment=window.closePayment; window.sendOrder=window.sendOrder;
    window.showProductDetail=window.showProductDetail; window.closeProductDetail=window.closeProductDetail; window.addToCartFromDetail=window.addToCartFromDetail; window.buyNowFromDetail=window.buyNowFromDetail;
    window.loginAdmin=window.loginAdmin; window.saveSettings=window.saveSettings; 
    window.handleImageUpload=window.handleImageUpload; window.saveProduct=window.saveProduct; window.editProd=window.editProd; window.delProd=window.delProd; window.cancelEdit=window.cancelEdit;

  </script>
</body>
</html>
